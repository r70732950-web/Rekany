<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maten Store - فرۆشتن و کاڵا</title>
    <meta http-equiv="Content-Language" content="ku">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a365d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Maten Store">
    <link rel="apple-touch-icon" href="images/icons/icon-512x512.png">
    
    <style>
        @font-face {
            font-family: 'NRT';
            src: url('https://www.nrttv.com/css/fonts/NRT-Reg.woff2') format('woff2'),
                 url('https://www.nrttv.com/css/fonts/NRT-Reg.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }@font-face {
        font-family: 'NRT';
        src: url('https://www.nrttv.com/css/fonts/NRT-Bold.woff2') format('woff2'),
             url('https://www.nrttv.com/css/fonts/NRT-Bold.woff') format('woff');
        font-weight: bold;
        font-display: swap;
        }
        
        :root {
            --primary-color: #1a365d;
            --primary-light: #2a4365;
            --accent-color: #2f855a;
            --accent-light: #38a169;
            --danger-color: #c53030;
            --danger-light: #e53e3e;
            --text-color: #2d3748;
            --text-light: #4a5568;
            --light-gray: #f0f2f5; 
            --medium-gray: #e2e8f0;
            --dark-gray: #718096;
            --section-bg: #ffffff; 
            --section-border: #e2e8f0; 
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'NRT', sans-serif; }
        
        body { 
            background-color: var(--light-gray); 
            color: var(--text-color); 
            direction: rtl; 
            overflow-x: hidden;
        }
        body.overlay-active {
            overflow: hidden;
        }
        
        .app-container { max-width: 100%; margin: 0 auto; background-color: var(--light-gray); min-height: 100vh; position: relative; overflow-x: hidden; } 

        .app-header { 
            background-color: white; 
            color: var(--primary-color); 
            padding: 12px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: fixed;
            top: 0; 
            left: 0;
            right: 0;
            z-index: 100; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-bottom: 1px solid var(--medium-gray); 
            gap: 15px;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-bottom { font-size: 22px; font-weight: bold; color: var(--primary-color); white-space: nowrap; }
        
        .page {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .page-hidden {
            opacity: 0;
            visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        
        .main-content { 
            padding-top: 80px; 
            padding-bottom: 85px; 
        }
        
        .section {
            background-color: var(--section-bg);
            border-radius: 12px;
            margin: 0 12px 16px;
            padding: 16px;
            border: 1px solid var(--section-border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .subcategories-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 5px 0 15px 0; 
            scrollbar-width: none;
        }
        .subcategories-container::-webkit-scrollbar {
            display: none;
        }

        .subcategory-btn {
            padding: 8px 16px;
            border: 1px solid var(--medium-gray);
            background-color: var(--light-gray);
            color: var(--text-light);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .subcategory-btn:hover {
            background-color: var(--medium-gray);
        }
        .subcategory-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            border-color: var(--primary-color);
        }

        .search-container { 
            flex-grow: 1;
            margin: 0;
            position: relative;
        }
        .search-input { width: 100%; padding: 10px 40px 10px 40px; border: 1px solid var(--section-border); border-radius: 6px; font-size: 15px; background-color: var(--light-gray); }
        .search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--dark-gray); }
        .clear-search-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 20px;
            color: var(--dark-gray);
            cursor: pointer;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-icon-btn {
            background: none;
            border: none;
            font-size: 22px;
            color: var(--primary-color);
            cursor: pointer;
            position: relative;
            padding: 5px;
        }
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 2px;
            width: 10px;
            height: 10px;
            background-color: var(--danger-color);
            border-radius: 50%;
            border: 2px solid white;
        }

        .notification-item {
            background-color: #ffffff;
            border: 1px solid var(--section-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .notification-item:last-child {
            margin-bottom: 0;
        }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .notification-title {
            font-weight: bold;
            font-size: 16px;
            color: var(--primary-color);
        }
        .notification-date {
            font-size: 12px;
            color: var(--dark-gray);
        }
        .notification-content {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-light);
        }
        .admin-notification-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid var(--section-border);
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: #fff;
        }
        .admin-notification-details {
            max-width: calc(100% - 40px);
        }
        .admin-notification-details .notification-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ========= START: YOUR PREFERRED PRODUCT CARD STYLE ========= */
        .products-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(125px, 1fr));
            gap: 12px;
        }
        
        .product-card { 
            background-color: white; 
            border-radius: 12px;
            overflow: hidden; 
            position: relative; 
            border: 1px solid var(--section-border); 
            display: flex; 
            flex-direction: column; 
            cursor: pointer; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }
        
        .product-card-reveal {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .product-card-reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .product-image-container { width: 100%; aspect-ratio: 1/1; position: relative; }
        .product-image { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            padding: 10px; 
            background-color: #f8f9fa;
        }
        
        .product-info {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .product-name { 
            font-weight: bold; 
            font-size: 14px; 
        }
        
        .product-price-container { 
            display: flex; 
            flex-direction: row;
            align-items: center; 
            justify-content: center;
            gap: 8px; 
            margin-top: 4px;
            margin-bottom: 8px;
        }
        
        .product-description { display: none; }
        
        .product-price { color: var(--accent-light); font-weight: 700; font-size: 15px; }
        .original-price { color: var(--dark-gray); text-decoration: line-through; font-size: 13px; }
        .discount-badge { position: absolute; top: 8px; right: 8px; background-color: var(--danger-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        
        .product-actions { 
            position: absolute; 
            top: 5px; 
            left: 45px;
            display: flex; 
            gap: 5px; 
            flex-direction: column; 
        }
        .edit-btn, .delete-btn { width: 28px; height: 28px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 13px; color: white; cursor: pointer; }
        .edit-btn { background-color: var(--accent-color); }
        .delete-btn { background-color: var(--danger-color); }

        .add-to-cart-btn-card { 
            width: 100%;
            padding: 8px;
            margin-top: auto;
            background-color: var(--accent-color); 
            color: white; 
            border: none; 
            border-radius: 6px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 8px;
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .add-to-cart-btn-card:hover { background-color: var(--accent-light); }
        .add-to-cart-btn-card:disabled {
             background-color: var(--dark-gray);
             cursor: not-allowed;
        }
        
        .favorite-btn {
            position: absolute; top: 8px; left: 8px; background: rgba(255, 255, 255, 0.8); border: 1px solid var(--medium-gray);
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;
            font-size: 16px; color: var(--dark-gray); transition: color 0.2s, transform 0.2s; z-index: 5;
        }
        .favorite-btn:hover { transform: scale(1.1); }
        .favorite-btn.favorited { color: var(--danger-color); }
        /* ========= END: YOUR PREFERRED PRODUCT CARD STYLE ========= */

        .add-to-cart-btn { 
            width: 100%;
            height: auto;
            padding: 8px;
            margin-top: auto; 
            background-color: var(--accent-color); 
            color: white; 
            border: none; 
            border-radius: 6px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 8px;
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
        }
        .add-to-cart-btn:hover { background-color: var(--accent-light); }
        
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 2000; overflow-y: auto; }
        .modal-content { 
            background-color: white; margin: 30px auto; padding: 20px; border-radius: 8px; 
            width: 90%; max-width: 450px; position: relative;
            animation: scaleIn 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .close { position: absolute; top: 12px; left: 12px; font-size: 22px; cursor: pointer; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--section-border); border-radius: 6px; }
        button[type="submit"] { background-color: var(--accent-color); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; }
        .notification { position: fixed; top: 15px; right: 15px; padding: 12px 16px; border-radius: 6px; color: white; z-index: 9999; opacity: 0; transform: translateX(100%); transition: all 0.3s; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: var(--accent-color); }
        .notification.error { background-color: var(--danger-color); }
        .add-product-btn { display: none; position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; background-color: var(--accent-color); border-radius: 50%; align-items: center; justify-content: center; color: white; font-size: 20px; cursor: pointer; z-index: 80; }
        
        .cart-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--section-border); justify-content: space-between; gap: 10px; }
        .cart-item-image { width: 60px; height: 60px; object-fit: contain; border-radius: 6px; margin-left: 10px; }
        .cart-item-details { flex-grow: 1; }
        .cart-item-title { font-weight: bold; }
        .cart-item-quantity { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
        .quantity-btn { width: 28px; height: 28px; border: 1px solid var(--medium-gray); background-color: var(--light-gray); border-radius: 50%; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .quantity-btn:hover { background-color: var(--medium-gray); }
        .quantity-text { font-weight: bold; font-size: 16px; min-width: 20px; text-align: center; }
        .cart-item-subtotal { text-align: left; display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between; font-size: 13px; color: var(--dark-gray); }
        .cart-item-subtotal span { font-weight: bold; font-size: 15px; color: var(--text-color); }
        .cart-item-remove { color: var(--danger-color); background: none; border: none; cursor: pointer; font-size: 16px; margin-top: 5px; }
        .cart-total { font-weight: bold; font-size: 17px; margin-top: 12px; text-align: left; }
        
        .cart-empty { text-align: center; padding: 25px; color: var(--dark-gray); }
        .cart-empty i { font-size: 45px; margin-bottom: 12px; color: var(--medium-gray); }

        .cart-actions { display:none; margin-top: 15px; }
        
        .whatsapp-btn, .viber-btn, .telegram-btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%; border: none; color: white; }
        .whatsapp-btn { background-color: #25D366; }
        .viber-btn { background-color: #7360F2; }
        .telegram-btn { background-color: #229ED9; }
        
        .details-btn { display: block; margin-top: 8px; padding: 6px; background-color: var(--primary-color); color: white; text-align: center; text-decoration: none; border-radius: 4px; font-size: 13px; transition: background-color 0.2s; }
        .details-btn:hover { background-color: var(--primary-light); }
        
        .bottom-nav { display: flex; justify-content: space-around; align-items: stretch; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; height: 65px; background-color: #ffffff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; border-top: 1px solid var(--medium-gray); }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-color);
            text-decoration: none;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
            position: relative;
            padding: 5px 0;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        
        .bottom-nav-item.active {
            border-bottom-color: var(--accent-light);
        }

        .bottom-nav-item:hover { background-color: var(--light-gray); }
        .bottom-nav-item i { font-size: 20px; color: var(--primary-color); transition: color 0.2s; }
        .bottom-nav-item.active i,
        .bottom-nav-item.active span {
            color: var(--accent-light);
            font-weight: bold;
        }
        .bottom-nav-item .cart-count { position: absolute; top: 5px; left: calc(50% + 5px); background-color: var(--danger-light); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 11px; border: 1px solid white; }
        
        .contact-dropdown { position: relative; }
        .contact-menu { display: none; position: absolute; bottom: 65px; background: #fff; border: 1px solid var(--medium-gray); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); flex-direction: column; min-width: 120px; z-index: 2000; }
        .contact-menu button { background: none; border: none; padding: 10px; text-align: right; width: 100%; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .contact-menu button:hover { background-color: var(--light-gray); }
        .contact-dropdown.open .contact-menu { display: flex; }
    
        .sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1500; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .sheet-overlay.show { opacity: 1; visibility: visible; }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background-color: white; border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); transform: translateY(100%); transition: transform 0.3s ease-out; z-index: 1600; max-height: 80vh; display: flex; flex-direction: column; }
        .bottom-sheet.show { transform: translateY(0); }
        .sheet-header { padding: 12px; text-align: center; border-bottom: 1px solid var(--medium-gray); position: relative; flex-shrink: 0; }
        .sheet-handle { width: 40px; height: 5px; background-color: var(--medium-gray); border-radius: 3px; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); }
        .sheet-title { font-size: 17px; margin-top: 15px; font-weight: bold; }
        .sheet-content { padding: 15px; overflow-y: auto; }

        .sheet-category-btn { background-color: var(--light-gray); border: 1px solid var(--section-border); padding: 12px; border-radius: 6px; width: 100%; text-align: right; cursor: pointer; font-size: 15px; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s, color 0.2s; margin-bottom: 10px; }
        .sheet-category-btn:last-child { margin-bottom: 0; }
        .sheet-category-btn:hover { background-color: var(--medium-gray); }
        .sheet-category-btn.active { background-color: var(--primary-color); color: white; font-weight: bold; border-color: var(--primary-color); }
        .sheet-category-btn.active i { color: white !important; }
        
        #sheetImageSlider { position: relative; max-width: 100%; margin-bottom: 15px; }
        #sheetImageContainer { display: flex; overflow: hidden; border-radius: 8px; }
        #sheetImageContainer img { width: 100%; flex-shrink: 0; display: none; object-fit: contain; max-height: 350px; transition: opacity 0.3s ease-in-out; }
        #sheetImageContainer img.active { display: block; }
        .slider-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.4); color: white; border: none; font-size: 20px; cursor: pointer; z-index: 10; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .slider-btn.prev { left: 10px; }
        .slider-btn.next { right: 10px; }
        #sheetThumbnailContainer { display: flex; justify-content: center; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .thumbnail { width: 60px; height: 60px; object-fit: contain; border: 2px solid var(--medium-gray); border-radius: 4px; cursor: pointer; opacity: 0.6; transition: all 0.2s; }
        .thumbnail.active { border-color: var(--primary-color); opacity: 1; }
        #sheetProductDescription a { color: var(--primary-color); text-decoration: underline; font-weight: bold; }
        
        .image-inputs-container { display: flex; flex-direction: column; gap: 10px; }
        .image-input-group { display: flex; gap: 8px; align-items: center; }
        .image-input-group input { flex-grow: 1; }
        .image-preview-small { width: 40px; height: 40px; object-fit: contain; border-radius: 4px; background-color: var(--light-gray); border: 1px solid var(--medium-gray); }

        .settings-page {
            padding-top: 80px; 
            padding-left: 15px;
            padding-right: 15px;
            padding-bottom: 85px;
        }
        .settings-group {
            background-color: white; border-radius: 8px; margin-bottom: 15px;
            border: 1px solid var(--section-border); overflow: hidden;
        }
        .settings-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; cursor: pointer; border-bottom: 1px solid var(--section-border);
            color: var(--text-color); text-decoration: none;
        }
        .settings-item:last-child { border-bottom: none; }
        .settings-item:hover { background-color: var(--light-gray); }
        .settings-item i.fa-chevron-left, .settings-item i.fa-external-link-alt, .settings-item .contact-chevron { color: var(--dark-gray); }
        .settings-item i { font-size: 18px; }
        .settings-item .fa-chevron-left, .settings-item i.fa-external-link-alt, .settings-item .contact-chevron { font-size: 14px; }
        .language-selector { display: flex; gap: 10px; }
        .lang-btn {
            background-color: var(--medium-gray); border: 2px solid transparent;
            border-radius: 6px; padding: 5px 12px; cursor: pointer; font-weight: bold;
        }
        .lang-btn.active {
            border-color: var(--primary-color); background-color: var(--primary-light); color: white;
        }

        .contact-links-container {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #f8f9fa;
        }
        .contact-links-container.open { max-height: 1000px; transition: max-height 0.4s ease-in; }
        .contact-links-container .settings-item { padding-right: 30px; }
        .contact-chevron { transition: transform 0.3s ease; }
        .contact-chevron.open { transform: rotate(-90deg); }

        .location-btn {
            width: 100%; 
            margin-top: 8px; 
            padding: 8px; 
            background-color: var(--primary-light); 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            font-size: 14px;
        }
        .location-btn:disabled {
            background-color: var(--dark-gray);
            cursor: not-allowed;
        }

        @keyframes shimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }
        .skeleton-card {
            background-color: #ffffff; border-radius: 8px; overflow: hidden;
            border: 1px solid var(--section-border);
        }
        .skeleton-image {
            width: 100%; aspect-ratio: 1/1; background-color: #e0e0e0;
        }
        .skeleton-text {
            height: 14px; width: 80%; background-color: #e0e0e0; margin: 12px; border-radius: 4px;
        }
        .skeleton-price {
            height: 15px; width: 50%; background-color: #e0e0e0; margin: 0 12px 12px; border-radius: 4px;
        }
        .skeleton-button {
            height: 35px; background-color: #e0e0e0; margin: 12px; border-radius: 6px;
        }
        .skeleton-card .shimmer {
            animation: shimmer 1.5s linear infinite;
            background: linear-gradient(to right, #eeeeee 8%, #dddddd 18%, #eeeeee 33%);
            background-size: 1000px 100%;
        }

        .update-notification {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            align-items: center;
            gap: 15px;
            transition: all 0.4s ease-in-out;
            opacity: 0;
        }

        .update-notification.show {
            display: flex;
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .update-now-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }
        .update-now-btn:hover {
            background-color: var(--accent-light);
        }

        .main-categories-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0 15px 0;
            scrollbar-width: none;
        }
        .main-categories-container::-webkit-scrollbar {
            display: none;
        }

        .main-category-btn {
            padding: 10px 15px;
            border: 1px solid var(--medium-gray);
            background-color: white;
            color: var(--text-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            font-weight: bold;
        }

        .main-category-btn i {
            color: var(--primary-color);
            font-size: 16px;
        }

        .main-category-btn:hover {
            background-color: var(--light-gray);
            border-color: var(--dark-gray);
        }

        .main-category-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .main-category-btn.active i {
            color: white !important;
        }
        
        .social-link-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background-color: #ffffff;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--section-border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .social-link-item .item-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: normal;
            overflow: hidden;
            flex: 1;
        }
        .social-link-item .item-details {
              display: flex;
              flex-direction: column;
              align-items: flex-start;
              gap: 3px;
              overflow: hidden;
        }
        .social-link-item .item-name {
            font-weight: bold;
            font-size: 15px;
            color: var(--text-color);
        }
        .social-link-item .item-value {
            font-size: 13px;
            color: var(--text-light);
            direction: ltr;
            text-align: right;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .social-link-item i {
            font-size: 22px;
            width: 25px; 
            text-align: center;
        }
        .social-link-item .delete-btn {
            flex-shrink: 0;
        }
        
        /* === NEW CSS FOR iOS NATIVE FEEL === */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        .app-header {
            padding-top: calc(12px + env(safe-area-inset-top));
        }
        .bottom-nav {
            padding-bottom: env(safe-area-inset-bottom);
            height: calc(65px + env(safe-area-inset-bottom));
        }
        .main-content {
            padding-bottom: calc(85px + env(safe-area-inset-bottom));
        }
        .bottom-sheet {
            padding-bottom: env(safe-area-inset-bottom);
        }
        * {
            -webkit-tap-highlight-color: transparent;
        }
        body {
            -webkit-overflow-scrolling: touch;
        }
        body, .bottom-nav-item, .product-card {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo">
                <i class="fas fa-store" style="color: var(--accent-color); font-size: 24px;"></i>
                <span class="logo-bottom">فرۆشگای MATEN</span>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="گەڕان بە ناوی کاڵا..." data-translate-key="search_placeholder">
                <i class="fas fa-search search-icon"></i>
                <button id="clearSearchBtn" class="clear-search-btn" style="display: none;">&times;</button>
            </div>
            
            <div class="header-actions">
                <button id="notificationBtn" class="header-icon-btn">
                    <i class="fas fa-bell"></i>
                    <span id="notificationBadge" class="notification-badge" style="display: none;"></span>
                </button>
            </div>
        </header>

        <div id="loginModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 style="text-align: center; margin-bottom: 18px;" data-translate-key="admin_login_title">چوونەژوورەوەی بەڕێوەبەر</h2>
                <form id="loginForm">
                    <div class="form-group"><label for="email" data-translate-key="email_label">ئیمەیڵ:</label><input type="email" id="email" required></div>
                    <div class="form-group"><label for="password" data-translate-key="password_label">وشەی نهێنی:</label><input type="password" id="password" required></div>
                    <button type="submit" data-translate-key="login_button">چوونەژوورەوە</button>
                </form>
            </div>
        </div>
        
        <div id="welcomeModal" class="modal">
            <div class="modal-content" style="text-align: center;">
                <span class="close">&times;</span>
                <i class="fas fa-store" style="font-size: 40px; color: var(--accent-color); margin-bottom: 15px;"></i>
                <h2 style="margin-bottom: 10px;">بەخێرهاتن بۆ فرۆشگای MATEN</h2>
                <p style="color: var(--text-light);">هیوادارین ئەزموونێکی کڕینی خۆشت هەبێت!</p>
            </div>
        </div>

        <div id="sheet-overlay" class="sheet-overlay"></div>
        
        <div id="notificationsSheet" class="bottom-sheet">
            <div class="sheet-header">
                <span class="sheet-handle"></span>
                <h2 class="sheet-title"><i class="fas fa-bell"></i> <span data-translate-key="notifications_title">ئاگەهدارییەکان</span></h2>
                <span class="close" style="top: 20px;">&times;</span>
            </div>
            <div id="notificationsListContainer" class="sheet-content">
                </div>
        </div>

        <div id="cartSheet" class="bottom-sheet">
            <div class="sheet-header">
                <span class="sheet-handle"></span>
                <h2 class="sheet-title"><i class="fas fa-shopping-cart"></i> <span data-translate-key="cart_title">سەبەتەی کڕین</span></h2>
                <span class="close" style="top: 20px;">&times;</span>
            </div>
            <div class="sheet-content">
                <div id="cartItemsContainer"></div>
                <div id="emptyCartMessage" class="cart-empty" style="display:none;"><i class="fas fa-shopping-basket"></i><p data-translate-key="cart_empty">سەبەتەکەت بەتاڵە</p></div>
                <div id="cartTotal" class="cart-total" style="display:none;"><span data-translate-key="total_price">کۆی گشتی:</span> <span id="totalAmount">0</span> د.ع.</div>
                
                <div id="cartActions" style="display:none; margin-top: 15px;">
                    </div>
            </div>
        </div>

        <div id="categoriesSheet" class="bottom-sheet">
            <div class="sheet-header">
                <span class="sheet-handle"></span>
                <h2 class="sheet-title"><i class="fas fa-list"></i> <span data-translate-key="choose_category">هەڵبژاردنی جۆر</span></h2>
                 <span class="close" style="top: 20px;">&times;</span>
            </div>
            <div id="sheetCategoriesContainer" class="sheet-content"></div>
        </div>

        <div id="profileSheet" class="bottom-sheet">
            <div class="sheet-header">
                <span class="sheet-handle"></span>
                <h2 class="sheet-title"><i class="fas fa-user"></i> <span data-translate-key="profile_title">پڕۆفایلی من</span></h2>
                <span class="close" style="top: 20px;">&times;</span>
            </div>
            <div class="sheet-content">
                <form id="profileForm">
                    <div class="form-group">
                        <label for="profileName" data-translate-key="profile_name">ناو:</label>
                        <input type="text" id="profileName" placeholder="ناوی سیانی بنووسە" required>
                    </div>
                    <div class="form-group">
                        <label for="profileAddress" data-translate-key="profile_address">ناونیشان:</label>
                        <input type="text" id="profileAddress" placeholder="شار، گەڕەک، کۆڵان..." required>
                        <button type="button" id="getLocationBtn" class="location-btn">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>وەرگرتنا ناڤ و نیشانێ من ب GPS</span>
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="profilePhone" data-translate-key="profile_phone">ژمارەی تەلەفۆن:</label>
                        <input type="tel" id="profilePhone" placeholder="07XX XXX XXXX" required>
                    </div>
                    <button type="submit" data-translate-key="save_button">پاشەکەوتکردن</button>
                </form>
            </div>
        </div>

        <div id="favoritesSheet" class="bottom-sheet">
            <div class="sheet-header">
                <span class="sheet-handle"></span>
                <h2 class="sheet-title"><i class="fas fa-heart" style="color: var(--danger-color);"></i> <span data-translate-key="favorites_title">لیستی دڵخوازەکان</span></h2>
                <span class="close" style="top: 20px;">&times;</span>
            </div>
            <div class="sheet-content">
                <div id="favoritesContainer" class="products-container" style="display: grid;"></div>
                <div id="emptyFavoritesMessage" class="cart-empty" style="display:none;">
                    <i class="fas fa-heart-broken"></i>
                    <p data-translate-key="favorites_empty">لیستی دڵخوازەکانت بەتاڵە</p>
                </div>
            </div>
        </div>
        
        <div id="productDetailSheet" class="bottom-sheet">
            <div class="sheet-header">
                <span class="sheet-handle"></span>
                <h2 id="sheetProductName" class="sheet-title"></h2>
                <span class="close" style="top: 20px;">&times;</span>
            </div>
            <div class="sheet-content">
                <div id="sheetImageSlider">
                         <div id="sheetImageContainer"></div>
                         <button class="slider-btn prev" id="sheetPrevBtn" style="display: none;">&#10094;</button>
                         <button class="slider-btn next" id="sheetNextBtn" style="display: none;">&#10095;</button>
                </div>
                <div id="sheetThumbnailContainer"></div>
                <div id="sheetProductPrice" style="font-size: 22px; font-weight: bold; color: var(--accent-color); margin: 15px 0; text-align:center;"></div>
                <p id="sheetProductDescription" style="color: #4a5568; margin-bottom: 20px; text-align:right; line-height: 1.7;"></p>
                <button id="sheetAddToCartBtn" class="add-to-cart-btn" style="padding: 12px; font-size: 16px;"></button>
            </div>
        </div>


        <main class="main-content page" id="mainPage">
            <div class="section">
                <div id="mainCategoriesContainer" class="main-categories-container"></div>
                
                <div id="subcategoriesContainer" class="subcategories-container"></div>
                
                <div id="loader" style="text-align: center; padding: 40px; color: var(--dark-gray);"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top: 10px;" data-translate-key="loading_products">...خەریکی بارکردنی کاڵاکانە</p></div>
                <div id="skeletonLoader" class="products-container"></div>
                <div class="products-container" id="productsContainer" style="display: none;"></div>
            </div>
        </main>

        <div class="settings-page page page-hidden" id="settingsPage">
            <h3 class="section-title" style="margin: 0; border-radius: 8px 8px 0 0;"><i class="fas fa-cog"></i> <span data-translate-key="settings_title">ڕێکخستنەکان</span></h3>
            
            <div class="settings-group">
                <div class="settings-item">
                    <div>
                        <i class="fas fa-language" style="margin-left: 10px;"></i>
                        <span data-translate-key="language_label">زمان</span>
                    </div>
                    <div class="language-selector">
                        <button class="lang-btn" data-lang="ku_sorani">سۆرانی</button>
                        <button class="lang-btn" data-lang="ku_badini">بادینی</button>
                        <button class="lang-btn" data-lang="ar">عربي</button>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-item" id="settingsFavoritesBtn">
                    <div>
                        <i class="fas fa-heart" style="margin-left: 10px; color: var(--danger-color)"></i>
                        <span data-translate-key="favorites_title">لیستی دڵخوازەکان</span>
                    </div>
                    <i class="fas fa-chevron-left"></i>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-item" id="installAppBtn" style="display: none; cursor: pointer;">
                    <div>
                        <i class="fas fa-download" style="margin-left: 10px; color: var(--accent-color);"></i>
                        <span data-translate-key="install_app">دامەزراندنی ئەپ</span>
                    </div>
                    <i class="fas fa-chevron-left"></i>
                </div>
                <div class="settings-item" id="enableNotificationsBtn" style="cursor: pointer;">
                    <div>
                        <i class="fas fa-bell" style="margin-left: 10px; color: var(--accent-color);"></i>
                        <span data-translate-key="enable_notifications">چالاککردنی ئاگەدارییەکان</span>
                    </div>
                    <i class="fas fa-chevron-left"></i>
                </div>
                </div>
            
            <div class="settings-group">
                <div class="settings-item" id="contactToggle">
                    <div>
                        <i class="fas fa-comments" style="margin-left: 10px;"></i>
                        <span data-translate-key="contact_us_title">پەیوەندیمان پێوە بکە</span>
                    </div>
                    <i class="fas fa-chevron-down contact-chevron"></i>
                </div>
                <div class="contact-links-container" id="dynamicContactLinksContainer">
                </div>
            </div>
            
            <div class="settings-group">
                 <div class="settings-item" id="settingsAdminLoginBtn">
                    <div>
                        <i class="fas fa-user-shield" style="margin-left: 10px;"></i>
                        <span data-translate-key="admin_login_nav">چوونەژوورەوەی بەڕێوەبەر</span>
                    </div>
                    <i class="fas fa-chevron-left"></i>
                </div>
                 <div class="settings-item" id="settingsLogoutBtn" style="display: none;">
                    <div>
                        <i class="fas fa-sign-out-alt" style="margin-left: 10px;"></i>
                        <span data-translate-key="logout_nav">چوونەدەرەوە</span>
                    </div>
                    <i class="fas fa-chevron-left"></i>
                </div>
            </div>

            <div class="settings-group" id="adminCategoryManagement" style="display: none;">
                <h3 class="section-title" style="margin: 0; border-radius: 0; box-shadow: none;"><i class="fas fa-sitemap"></i> <span data-translate-key="manage_categories_title">بەڕێوەبردنی جۆرەکان</span></h3>
                
                <div style="padding: 15px; border-bottom: 1px solid var(--section-border);">
                    <form id="addCategoryForm">
                        <h4 style="margin-bottom: 10px; font-weight: bold; color: var(--primary-color);">زیادکردنی جۆری سەرەki</h4>
                        <div class="form-group">
                            <label>ناوی جۆر (سۆرانی):</label>
                            <input type="text" id="mainCategoryNameKuSorani" required>
                        </div>
                        <div class="form-group">
                            <label>ناوی جۆر (بادینی):</label>
                            <input type="text" id="mainCategoryNameKuBadini" required>
                        </div>
                         <div class="form-group">
                            <label>اسم الفئة (عربي):</label>
                            <input type="text" id="mainCategoryNameAr" required>
                        </div>
                        <div class="form-group">
                            <label>ئایکۆن (بۆ نموونە: fas fa-mobile-alt):</label>
                            <input type="text" id="mainCategoryIcon" required>
                        </div>
                        <div class="form-group">
                            <label>ژمارەی ڕیزبەندی:</label>
                            <input type="number" id="mainCategoryOrder" value="10" required>
                        </div>
                        <button type="submit" style="background-color: var(--primary-color);">پاشەکەوتکردنی جۆری سەرەکی</button>
                    </form>
                </div>
                
                <div style="padding: 15px;">
                    <form id="addSubcategoryForm">
                        <h4 style="margin-bottom: 10px; font-weight: bold; color: var(--primary-color);">زیادکردنی جۆری لاوەکی</h4>
                        <div class="form-group">
                            <label>جۆری سەرەکی هەڵبژێرە:</label>
                            <select id="parentCategorySelect" required>
                                <option value="" disabled selected>-- سەرەتا جۆرێک هەڵبژێرە --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ناوی جۆری لاوەکی (سۆرانی):</label>
                            <input type="text" id="subcategoryNameKuSorani" required>
                        </div>
                        <div class="form-group">
                            <label>ناوی جۆری لاوەکی (بادینی):</label>
                            <input type="text" id="subcategoryNameKuBadini" required>
                        </div>
                        <div class="form-group">
                            <label>اسم الفئة الفرعية (عربي):</label>
                            <input type="text" id="subcategoryNameAr" required>
                        </div>
                        <button type="submit">پاشەکەوتکردنی جۆری لاوەکی</button>
                    </form>
                </div>
            </div>
            
			<div class="settings-group" id="adminContactMethodsManagement" style="display: none;">
                <h3 class="section-title" style="margin: 0; border-radius: 0; box-shadow: none;"><i class="fas fa-paper-plane"></i> <span data-translate-key="manage_contact_methods_title">بەڕێوەبردنی شێوازەکانی ناردنی داواکاری</span></h3>
                
                <div style="padding: 15px;">
                    <form id="addContactMethodForm">
                        <h4 style="margin-bottom: 10px; font-weight: bold; color: var(--primary-color);">زیادکردنی شێوازی نوێ</h4>
                        
                        <div class="form-group">
                            <label>جۆری شێواز:</label>
                            <select id="contactMethodType" required>
                                <option value="whatsapp">واتسئاپ (Whatsapp)</option>
                                <option value="viber">ڤایبەر (Viber)</option>
                                <option value="telegram">تێلێگرام (Telegram)</option>
                                <option value="phone">پەیوەندی تەلەفۆنی (Phone Call)</option>
                                <option value="url">لینکی دەرەکی (Custom URL)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>زانیاری (ژمارە، یوزەرنەیم، یان لینک):</label>
                            <input type="text" id="contactMethodValue" placeholder="بۆ واتسئاپ/ڤایبەر: 9647..." required>
                        </div>

                        <div class="form-group">
                            <label>ناوی سەر دوگمە (سۆرانی):</label>
                            <input type="text" id="contactMethodNameKuSorani" placeholder="ناردن لە ڕێگەی واتسئاپ" required>
                        </div>
                        <div class="form-group">
                            <label>ناوی سەر دوگمە (بادینی):</label>
                            <input type="text" id="contactMethodNameKuBadini" placeholder="فرێکرن ب رێکا واتسئاپ" required>
                        </div>
                        <div class="form-group">
                            <label>ناوی سەر دوگمە (عربی):</label>
                            <input type="text" id="contactMethodNameAr" placeholder="إرسال عبر واتساب" required>
                        </div>
                        
                        <div class="form-group">
                            <label>کڵاسی ئایکۆنی Font Awesome:</label>
                            <input type="text" id="contactMethodIcon" placeholder="fab fa-whatsapp" required>
                        </div>

                        <div class="form-group">
                            <label>ڕەنگی دوگمە:</label>
                            <input type="color" id="contactMethodColor" value="#25D366" style="width: 100%; height: 40px;">
                        </div>

                        <button type="submit" style="background-color: var(--primary-color);">پاشەکەوتکردنی شێواز</button>
                    </form>

                    <hr style="margin: 20px 0;">

                    <h4 style="margin-bottom: 10px; font-weight: bold; color: var(--primary-color);">شێوازە زیادکراوەکان</h4>
                    <div id="contactMethodsListContainer">
                        </div>
                </div>
            </div>

            <div class="settings-group" id="adminSocialMediaManagement" style="display: none;">
                <div class="settings-item" id="socialMediaToggle">
                    <div>
                        <i class="fas fa-share-alt" style="margin-left: 10px;"></i>
                        <span>بەڕێوەبردنی سۆشیال میدیا</span>
                    </div>
                    <i class="fas fa-chevron-down contact-chevron"></i>
                </div>
                <div class="contact-links-container">
                    <div style="padding: 15px;">
                        <form id="addSocialMediaForm">
                            <h4 style="margin-bottom: 10px; font-weight: bold; color: var(--primary-color);">زیادکردنی لینکی نوێ</h4>
                            <div class="form-group">
                                <label>ناوی سۆشیال میدیا (سۆرانی):</label>
                                <input type="text" id="socialNameKuSorani" required>
                            </div>
                            <div class="form-group">
                                <label>ناوی سۆشیال میدیا (بادینی):</label>
                                <input type="text" id="socialNameKuBadini" required>
                            </div>
                            <div class="form-group">
                                <label>اسم المنصة (عربي):</label>
                                <input type="text" id="socialNameAr" required>
                            </div>
                            <div class="form-group">
                                <label>لینک (URL):</label>
                                <input type="url" id="socialUrl" placeholder="https://www.facebook.com/..." required>
                            </div>
                            <div class="form-group">
                                <label>کڵاسی ئایکۆن (بۆ نموونە: fab fa-facebook):</label>
                                <input type="text" id="socialIcon" placeholder="fab fa-instagram" required>
                                <small style="color: #777;">تکایە کڵاسەکانی Font Awesome بەکاربهێنە.</small>
                            </div>
                            <button type="submit" style="background-color: var(--primary-color);">پاشەکەوتکردنی لینک</button>
                        </form>
                        
                        <hr style="margin: 20px 0;">

                        <h4 style="margin-bottom: 10px; font-weight: bold; color: var(--primary-color);">لینکە زیادکراوەکان</h4>
                        <div id="socialLinksListContainer">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-group" id="adminAnnouncementManagement" style="display: none;">
                <h3 class="section-title" style="margin: 0; border-radius: 0; box-shadow: none;">
                    <i class="fas fa-bullhorn"></i> <span data-translate-key="manage_announcements_title">ناردنی ئاگەهداری گشتی</span>
                </h3>
                <div style="padding: 15px;">
                    <form id="announcementForm">
                        <h4 style="margin-bottom: 10px; font-weight: bold; color: var(--primary-color);" data-translate-key="send_new_announcement">ناردنی ئاگەهداری نوێ</h4>
                        <div class="form-group">
                            <label for="announcementTitleKuSorani">ناونیشان (سۆرانی):</label>
                            <input type="text" id="announcementTitleKuSorani" required>
                        </div>
                         <div class="form-group">
                            <label for="announcementTitleKuBadini">ناونیشان (بادینی):</label>
                            <input type="text" id="announcementTitleKuBadini" required>
                        </div>
                         <div class="form-group">
                            <label for="announcementTitleAr">ناونیشان (عربی):</label>
                            <input type="text" id="announcementTitleAr" required>
                        </div>
                        <hr style="margin: 20px 0; border-top: 1px solid var(--section-border);">
                        <div class="form-group">
                            <label for="announcementContentKuSorani">ناوەڕۆک (سۆرانی):</label>
                            <textarea id="announcementContentKuSorani" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="announcementContentKuBadini">ناوەڕۆک (بادینی):</label>
                            <textarea id="announcementContentKuBadini" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="announcementContentAr">ناوەڕۆک (عربی):</label>
                            <textarea id="announcementContentAr" rows="3" required></textarea>
                        </div>
                        <button type="submit" data-translate-key="send_announcement_button">ناردنی ئاگەهداری</button>
                    </form>
                    <hr style="margin: 25px 0;">
                    <h4 style="margin-bottom: 10px; font-weight: bold; color: var(--primary-color);" data-translate-key="sent_announcements">ئاگەهدارییە نێردراوەکان</h4>
                    <div id="announcementsListContainer">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="add-product-btn" id="addProductBtn"><i class="fas fa-plus"></i></div>

        <div id="productFormModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 id="formTitle" style="text-align: center; margin-bottom: 18px;">زیادکردنی کاڵای نوێ</h2>
                <form id="productForm">
                    <div class="form-group"><label for="productName">ناوی کاڵا:</label><input type="text" id="productName" required></div>
                    <div class="form-group"><label for="productPrice">نرخی فرۆشتن (د.ع.):</label><input type="number" id="productPrice" required min="0" step="1"></div>
                    <div class="form-group"><label for="productOriginalPrice">نرخی ڕەسەن (د.ع.):</label><input type="number" id="productOriginalPrice" min="0" step="1" placeholder="ئەگەر داشکانی نییە، بەتاڵ بێت"></div>
                    
                    <div class="form-group"><label for="productCategoryId">جۆری سەرەکی:</label>
                        <select id="productCategoryId" required>
                            <option value="" disabled selected>-- جۆرێ سەرەکی هەڵبژێرە --</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="subcategorySelectContainer" style="display: none;">
                        <label for="productSubcategoryId">جۆری لاوەکی:</label>
                        <select id="productSubcategoryId" required>
                            <option value="" disabled selected>-- سەرەتا جۆری سەرەکی هەڵبژێرە --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productDescriptionKuSorani">وەسف (سۆرانی):</label>
                        <textarea id="productDescriptionKuSorani" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="productDescriptionKuBadini">وەسف (بادینی):</label>
                        <textarea id="productDescriptionKuBadini" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="productDescriptionAr">وەسف (عربي):</label>
                        <textarea id="productDescriptionAr" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>لینکەکانی وێنەی کاڵا (تا 4 وێنە):</label>
                        <div class="image-inputs-container" id="imageInputsContainer"></div>
                    </div>
                    <div class="form-group"><label for="productExternalLink">لینکی دەرەکی:</label><input type="text" id="productExternalLink" placeholder="بۆ نموونە، لینکی ڤیدیۆ..."></div>
                    <button type="submit">پاشەکەوتکردن</button>
                </form>
            </div>
        </div>
        
        <div class="bottom-nav">
             <button id="homeBtn" class="bottom-nav-item">
                <i class="fas fa-home"></i>
                <span data-translate-key="nav_home">سەرەکی</span>
            </button>
            <button id="categoriesBtn" class="bottom-nav-item">
                <i class="fas fa-tags"></i>
                <span data-translate-key="nav_categories">جۆرەکان</span>
            </button>
            <button id="cartBtn" class="bottom-nav-item">
                <span class="cart-count" id="cartCount">0</span>
                <i class="fas fa-shopping-cart"></i>
                <span data-translate-key="nav_cart">سەبەتە</span>
            </button>
            <button id="profileBtn" class="bottom-nav-item">
                <i class="fas fa-user"></i>
                <span data-translate-key="nav_profile">پڕۆفایل</span>
            </button>
             <button id="settingsBtn" class="bottom-nav-item">
                <i class="fas fa-cog"></i>
                <span data-translate-key="nav_settings">ڕێکخستن</span>
            </button>
        </div>
    </div> 
    
    <div id="update-notification" class="update-notification">
        <span>ڤێرژنەکا نوی یا بەردەستە!</span>
        <button id="update-now-btn" class="update-now-btn">نوو بکە</button>
    </div>
    <script type="module"> 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging.js";
        import { setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";


        const firebaseConfig = {
            apiKey: "AIzaSyBxyy9e0FIsavLpWCFRMqgIbUU2IJV8rqE",
            authDomain: "maten-store.firebaseapp.com",
            projectId: "maten-store",
            storageBucket: "maten-store.appspot.com",
            messagingSenderId: "137714858202",
            appId: "1:137714858202:web:e2443a0b26aac6bb56cde3",
            measurementId: "G-1PV3DRY2V2"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const messaging = getMessaging(app);
        
        const productsCollection = collection(db, "products");
        const categoriesCollection = collection(db, "categories");
        const announcementsCollection = collection(db, "announcements");
        
        const translations = {
            ku_sorani: {
                search_placeholder: "گەڕان بە ناوی کاڵا...",
                admin_login_title: "چوونەژوورەوەی بەڕێوەبەر",
                email_label: "ئیمەیڵ:",
                password_label: "وشەی نهێنی:",
                login_button: "چوونەژوورەوە",
                cart_title: "سەبەتەی کڕین",
                cart_empty: "سەبەتەکەت بەتاڵە",
                total_price: "کۆی گشتی:",
                send_whatsapp: "ناردن لە ڕێگەی واتسئاپ",
                send_viber: "ناردن لە ڕێگەی فایبەر",
                send_telegram: "ناردن لە ڕێگەی تێلێگرام",
                favorites_title: "لیستی دڵخوازەکان",
                favorites_empty: "لیستی دڵخوازەکانت بەتاڵە",
                choose_category: "هەڵبژاردنی جۆر",
                all_products: "هەموو کاڵاکان",
                loading_products: "...خەریکی بارکردنی کاڵاکانە",
                settings_title: "ڕێکخستنەکان",
                language_label: "زمان",
                profile_title: "پڕۆفایلی من",
                admin_login_nav: "چوونەژوورەوەی بەڕێوەبەر",
                logout_nav: "چوونەدەرەوە",
                profile_name: "ناو:",
                profile_address: "ناونیشان:",
                profile_phone: "ژمارەی تەلەفۆن:",
                save_button: "پاشەکەوتکردن",
                nav_home: "سەرەکی",
                nav_categories: "جۆرەکان",
                nav_cart: "سەبەتە",
                nav_profile: "پڕۆفایل",
                nav_settings: "ڕێکخستن",
                contact_us_title: "پەیوەندیمان پێوە بکە",
                contact_whatsapp: "واتسئاپ",
                contact_viber: "فایبەر",
                contact_telegram: "تێلێگرام",
                add_to_cart: "زیادکردن بۆ سەبەتە",
                added_to_cart: "زیادکرا",
                product_not_found_error: "هەڵە: کاڵاکە نەدۆزرایەوە!",
                delete_confirm: "دڵنیایت دەتەوێت ئەم کاڵایە بسڕیتەوە؟",
                product_deleted: "کاڵا سڕدرایەوە",
                product_delete_error: "هەڵە لە سڕینەوەی کاڵا",
                order_greeting: "سڵاو! من پێویستم بەم کاڵایانەی خوارەوەیە:",
                order_item_details: "نرخ: {price} د.ع. | ژمارە: {quantity}",
                order_total: "کۆی گشتی",
                order_user_info: "--- زانیاری داواکار ---",
                order_user_name: "ناو",
                order_user_address: "ناونیشان",
                order_user_phone: "ژمارەی تەلەفۆن",
                order_prompt_info: "تکایە ناونیشان و زانیارییەکانت بنێرە بۆ گەیاندن.",
                login_error: "ئیمەیڵ یان وشەی نهێنی هەڵەیە",
                logout_success: "بە سەرکەوتوویی چوویتەدەرەوە",
                profile_saved: "زانیارییەکانی پڕۆفایل پاشەکەوتکران",
                all_categories_label: "هەموو",
                install_app: "دامەزراندنی ئەپ",
                product_added_to_cart: "کاڵاکە زیادکرا بۆ سەبەتە",
                product_added_to_favorites: "زیادکرا بۆ لیستی دڵخوازەکان",
                product_removed_from_favorites: "لە لیستی دڵخوازەکان سڕدرایەوە",
                manage_categories_title: "بەڕێوەبردنی جۆرەکان",
                manage_contact_title: "بەڕێوەبردنی زانیارییەکانی پەیوەندی",
				manage_contact_methods_title: "بەڕێوەبردنی شێوازەکانی ناردنی داواکاری",
                notifications_title: "ئاگەهدارییەکان",
                no_notifications_found: "هیچ ئاگەهدارییەک نییە",
                manage_announcements_title: "ناردنی ئاگەهداری گشتی",
                send_new_announcement: "ناردنی ئاگەهداری نوێ",
                announcement_title_label: "ناونیشانی ئاگەهداری:",
                announcement_content_label: "ناوەڕۆکی پەیام:",
                send_announcement_button: "ناردنی ئاگەهداری",
                sent_announcements: "ئاگەهدارییە نێردراوەکان",
                no_announcements_sent: "هیچ ئاگەهدارییەک نەنێردراوە",
                announcement_deleted_success: "ئاگەهدارییەکە سڕدرایەوە",
                announcement_delete_confirm: "دڵنیایت دەتەوێت ئەم ئاگەهدارییە بسڕیتەوە؟",
                enable_notifications: "چالاککردنی ئاگەدارییەکان",
                error_generic: "هەڵەیەک ڕوویدا!",
            },
            ku_badini: {
                search_placeholder: "لێگەریان ب ناڤێ کاڵای...",
                admin_login_title: "چوونا ژوور یا بەرپرسى",
                email_label: "ئیمەیل:",
                password_label: "پەیڤا نهێنى:",
                login_button: "چوونا ژوور",
                cart_title: "سەلکا کرینێ",
                cart_empty: "سەلکا تە یا ڤالایە",
                total_price: "کۆمێ گشتی:",
                send_whatsapp: "فرێکرن ب رێکا واتسئاپ",
                send_viber: "فرێکرن ب رێکا ڤایبەر",
                send_telegram: "فرێکرن ب رێکا تێلێگرام",
                favorites_title: "لیستا حەزژێکریان",
                favorites_empty: "لیستا حەزژێکریێن تە یا ڤالایە",
                choose_category: "جورەکی هەلبژێرە",
                all_products: "هەمی کاڵا",
                loading_products: "...د بارکرنا کاڵایان دایە",
                settings_title: "ڕێکخستن",
                language_label: "زمان",
                profile_title: "پروفایلێ من",
                admin_login_nav: "چوونا ژوور یا بەرپرسى",
                logout_nav: "چوونا دەر",
                profile_name: "ناڤ:",
                profile_address: "ناڤ و نیشان:",
                profile_phone: "ژمارا تەلەفونێ:",
                save_button: "پاشەکەفتکرن",
                nav_home: "سەرەکی",
                nav_categories: "جۆر",
                nav_cart: "سەلک",
                nav_profile: "پروفایل",
                nav_settings: "ڕێکخستن",
                contact_us_title: "پەیوەندیێ ب مە بکە",
                contact_whatsapp: "واتسئاپ",
                contact_viber: "ڤایبەر",
                contact_telegram: "تێلێگرام",
                add_to_cart: "زێدەکرن بۆ سەلکێ",
                added_to_cart: "زێدەکر",
                product_not_found_error: "خەلەتی: کاڵا نەهاتە دیتن!",
                delete_confirm: "تو پشتڕاستی دێ ڤی کاڵای ژێبەى؟",
                product_deleted: "کاڵا هاتە ژێبرن",
                product_delete_error: "خەلەتی د ژێبرنا کاڵای دا",
                order_greeting: "سلاڤ! ئەز پێدڤی ب ڤان کاڵایێن خوارێ مە:",
                order_item_details: "بها: {price} د.ع. | ژمارە: {quantity}",
                order_total: "کۆمێ گشتی",
                order_user_info: "--- پێزانینێن داخازکەری ---",
                order_user_name: "ناڤ",
                order_user_address: "ناڤ و نیشان",
                order_user_phone: "ژمارا تەلەفونێ",
                order_prompt_info: "هیڤی دکەین ناڤ و نیشان و پێزانینێن خۆ فرێکە بۆ گەهاندنێ.",
                login_error: "ئیمەیل یان پەیڤا نهێنى یا خەلەتە",
                logout_success: "ب سەرکەفتیانە چوويه دەر",
                profile_saved: "پێزانینێن پروفایلی هاتنە پاشەکەفتکرن",
                all_categories_label: "هەمی",
                install_app: "دامەزراندنا ئەپی",
                product_added_to_cart: "کاڵا هاتە زێدەکرن بۆ سەلکێ",
                product_added_to_favorites: "هاتە زێدەکرن بۆ لیستا حەزژێکریان",
                product_removed_from_favorites: "ژ لیستا حەزژێکریان هاتە ژێبرن",
                manage_categories_title: "رێکخستنا جوران",
                manage_contact_title: "рێکخستنا پێزانینێن پەیوەندیێ",
				manage_contact_methods_title: "رێکخستنا رێکێن فرێکرنا داخازیێ",
                notifications_title: "ئاگەهداری",
                no_notifications_found: "چ ئاگەهداری نینن",
                manage_announcements_title: "رێکخستنا ئاگەهداریان",
                send_new_announcement: "فرێکرنا ئاگەهداریەکا نوو",
                announcement_title_label: "ناڤ و نیشانێ ئاگەهداریێ:",
                announcement_content_label: "ناڤەرۆکا پەیامێ:",
                send_announcement_button: "ئاگەهداریێ فرێکە",
                sent_announcements: "ئاگەهداریێن هاتینە فرێکرن",
                no_announcements_sent: "چ ئاگەهداری نەهاتینە فرێکرن",
                announcement_deleted_success: "ئاگەهداری هاتە ژێبرن",
                announcement_delete_confirm: "تو پشتڕاستی دێ ڤێ ئاگەهداریێ ژێبەی؟",
                enable_notifications: "چالاکرنا ئاگەهداریان",
                error_generic: "خەلەتییەک چێبوو!",
            },
            ar: {
                search_placeholder: "البحث باسم المنتج...",
                admin_login_title: "تسجيل دخول المسؤول",
                email_label: "البريد الإلكتروني:",
                password_label: "كلمة المرور:",
                login_button: "تسجيل الدخول",
                cart_title: "سلة التسوق",
                cart_empty: "سلتك فارغة",
                total_price: "المجموع الكلي:",
                send_whatsapp: "إرسال عبر واتساب",
                send_viber: "إرسال عبر فايبر",
                send_telegram: "إرسال عبر تليجرام",
                favorites_title: "قائمة المفضلة",
                favorites_empty: "قائمة المفضلة فارغة",
                choose_category: "اختر الفئة",
                all_products: "كل المنتجات",
                loading_products: "...جاري تحميل المنتجات",
                settings_title: "الإعدادات",
                language_label: "اللغة",
                profile_title: "ملفي الشخصي",
                admin_login_nav: "تسجيل دخول المسؤول",
                logout_nav: "تسجيل الخروج",
                profile_name: "الاسم:",
                profile_address: "العنوان:",
                profile_phone: "رقم الهاتف:",
                save_button: "حفظ",
                nav_home: "الرئيسية",
                nav_categories: "الفئات",
                nav_cart: "السلة",
                nav_profile: "ملفي",
                nav_settings: "الإعدادات",
                contact_us_title: "تواصل معنا",
                contact_whatsapp: "واتساب",
                contact_viber: "فايبر",
                contact_telegram: "تليجرام",
                add_to_cart: "إضافة إلى السلة",
                added_to_cart: "تمت الإضافة",
                product_not_found_error: "خطأ: المنتج غير موجود!",
                delete_confirm: "هل أنت متأكد من أنك تريد حذف هذا المنتج؟",
                product_deleted: "تم حذف المنتج",
                product_delete_error: "خطأ في حذف المنتج",
                order_greeting: "مرحباً! أحتاج إلى المنتجات التالية:",
                order_item_details: "السعر: {price} د.ع. | الكمية: {quantity}",
                order_total: "المجموع الكلي",
                order_user_info: "--- معلومات العميل ---",
                order_user_name: "الاسم",
                order_user_address: "العنوان",
                order_user_phone: "رقم الهاتف",
                order_prompt_info: "يرجى إرسال عنوانك وتفاصيلك للتوصيل.",
                login_error: "البريد الإلكتروني أو كلمة المرور غير صحيحة",
                logout_success: "تم تسجيل الخروج بنجاح",
                profile_saved: "تم حفظ معلومات الملف الشخصي",
                all_categories_label: "الكل",
                install_app: "تثبيت التطبيق",
                product_added_to_cart: "تمت إضافة المنتج إلى السلة",
                product_added_to_favorites: "تمت الإضافة إلى المفضلة",
                product_removed_from_favorites: "تمت الإزالة من المفضلة",
                manage_categories_title: "إدارة الفئات",
                manage_contact_title: "إدارة معلومات الاتصال",
				manage_contact_methods_title: "إدارة طرق إرسال الطلب",
                notifications_title: "الإشعارات",
                no_notifications_found: "لا توجد إشعارات",
                manage_announcements_title: "إدارة الإشعارات العامة",
                send_new_announcement: "إرسال إشعار جدید",
                announcement_title_label: "عنوان الإشعار:",
                announcement_content_label: "محتوى الرسالة:",
                send_announcement_button: "إرسال الإشعار",
                sent_announcements: "الإشعارات المرسلة",
                no_announcements_sent: "لم يتم إرسال أي إشعارات",
                announcement_deleted_success: "تم حذف الإشعار",
                announcement_delete_confirm: "هل أنت متأكد من حذف هذا الإشعار؟",
                enable_notifications: "تفعيل الإشعارات",
                error_generic: "حدث خطأ!",
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'ku_sorani';
        let deferredPrompt; 

        const CART_KEY = "maten_store_cart";
        let cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];

        const FAVORITES_KEY = "maten_store_favorites";
        let favorites = JSON.parse(localStorage.getItem(FAVORITES_KEY)) || [];
        
        const PROFILE_KEY = "maten_store_profile";
        let userProfile = JSON.parse(localStorage.getItem(PROFILE_KEY)) || {};

        let isAdmin = false;
        let editingProductId = null;
        let currentCategory = 'all';
        let currentSearch = '';
        let products = [];
        let categories = [];
        let contactInfo = {};
        
        let currentSubcategory = 'all'; 
        let subcategories = [];

        // ========== START: ELEMENT SELECTORS ==========
        const loginModal = document.getElementById('loginModal');
        const addProductBtn = document.getElementById('addProductBtn');
        const productFormModal = document.getElementById('productFormModal');
        const productsContainer = document.getElementById('productsContainer');
        const skeletonLoader = document.getElementById('skeletonLoader');
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const loginForm = document.getElementById('loginForm');
        const productForm = document.getElementById('productForm');
        const formTitle = document.getElementById('formTitle');
        const imageInputsContainer = document.getElementById('imageInputsContainer');
        const loader = document.getElementById('loader');
        const cartBtn = document.getElementById('cartBtn');
        const cartItemsContainer = document.getElementById('cartItemsContainer');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const cartTotal = document.getElementById('cartTotal');
        const totalAmount = document.getElementById('totalAmount');
        const cartActions = document.getElementById('cartActions');
        const favoritesContainer = document.getElementById('favoritesContainer');
        const emptyFavoritesMessage = document.getElementById('emptyFavoritesMessage');
        const categoriesBtn = document.getElementById('categoriesBtn');
        const sheetOverlay = document.getElementById('sheet-overlay');
        const sheetCategoriesContainer = document.getElementById('sheetCategoriesContainer');
        const productCategorySelect = document.getElementById('productCategoryId');
        const subcategorySelectContainer = document.getElementById('subcategorySelectContainer');
        const productSubcategorySelect = document.getElementById('productSubcategoryId');
        const profileForm = document.getElementById('profileForm');
        const settingsPage = document.getElementById('settingsPage');
        const mainPage = document.getElementById('mainPage');
        const homeBtn = document.getElementById('homeBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsFavoritesBtn = document.getElementById('settingsFavoritesBtn');
        const settingsAdminLoginBtn = document.getElementById('settingsAdminLoginBtn');
        const settingsLogoutBtn = document.getElementById('settingsLogoutBtn');
        const profileBtn = document.getElementById('profileBtn');
        const contactToggle = document.getElementById('contactToggle');
        const adminSocialMediaManagement = document.getElementById('adminSocialMediaManagement');
        const addSocialMediaForm = document.getElementById('addSocialMediaForm');
        const socialLinksListContainer = document.getElementById('socialLinksListContainer');
        const socialMediaToggle = document.getElementById('socialMediaToggle');
        const notificationBtn = document.getElementById('notificationBtn');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationsSheet = document.getElementById('notificationsSheet');
        const notificationsListContainer = document.getElementById('notificationsListContainer');
        const adminAnnouncementManagement = document.getElementById('adminAnnouncementManagement');
        const announcementForm = document.getElementById('announcementForm');
        // ========== END: ELEMENT SELECTORS ==========


        // ========== START: NEW NAVIGATION & POPUP LOGIC ==========
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.toggle('page-hidden', page.id !== pageId);
            });
            const activeBtnId = pageId === 'mainPage' ? 'homeBtn' : 'settingsBtn';
            updateActiveNav(activeBtnId);
        }

        function closeAllPopupsUI() {
            document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
            document.querySelectorAll('.bottom-sheet').forEach(sheet => sheet.classList.remove('show'));
            sheetOverlay.classList.remove('show');
            document.body.classList.remove('overlay-active');
        }

        function openPopup(id, type = 'sheet') {
            const element = document.getElementById(id);
            if (!element) return;

            closeAllPopupsUI(); 
            if (type === 'sheet') {
                sheetOverlay.classList.add('show');
                element.classList.add('show');
                 if (id === 'cartSheet') renderCart();
                 if (id === 'favoritesSheet') renderFavoritesPage();
                 if (id === 'categoriesSheet') renderCategoriesSheet();
                 if (id === 'notificationsSheet') renderUserNotifications();
                 if (id === 'profileSheet') {
                     document.getElementById('profileName').value = userProfile.name || '';
                     document.getElementById('profileAddress').value = userProfile.address || '';
                     document.getElementById('profilePhone').value = userProfile.phone || '';
                 }
            } else { 
                element.style.display = 'block';
            }
            document.body.classList.add('overlay-active');
            
            history.pushState({ type: type, id: id }, '', `#${id}`);
        }

        function closeCurrentPopup() {
            if (history.state && (history.state.type === 'sheet' || history.state.type === 'modal')) {
                history.back();
            } else {
                closeAllPopupsUI();
            }
        }
        
        window.addEventListener('popstate', (event) => {
            closeAllPopupsUI();
            const state = event.state;
            if (state) {
                if (state.type === 'page') {
                    showPage(state.id);
                } else if (state.type === 'sheet' || state.type === 'modal') {
                    openPopup(state.id, state.type);
                }
            } else {
                showPage('mainPage');
            }
        });

        function handleInitialPageLoad() {
            const hash = window.location.hash.substring(1);
            const element = document.getElementById(hash);
            
            if (hash === 'settingsPage') {
                showPage('settingsPage');
                history.replaceState({ type: 'page', id: 'settingsPage' }, '', '#settingsPage');
            } else {
                showPage('mainPage');
                history.replaceState({ type: 'page', id: 'mainPage' }, '', window.location.pathname);
            }

            if (element) {
                const isSheet = element.classList.contains('bottom-sheet');
                const isModal = element.classList.contains('modal');
                if (isSheet || isModal) {
                    openPopup(hash, isSheet ? 'sheet' : 'modal');
                }
            }
        }
        // ========== END: NEW NAVIGATION & POPUP LOGIC ==========


        function t(key, replacements = {}) {
            let translation = translations[currentLanguage][key] || translations['ku_sorani'][key] || key;
            for (const placeholder in replacements) {
                translation = translation.replace(`{${placeholder}}`, replacements[placeholder]);
            }
            return translation;
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            document.documentElement.lang = lang.startsWith('ar') ? 'ar' : 'ku';
            document.documentElement.dir = 'rtl';

            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.dataset.translateKey;
                const translation = t(key);
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    if (element.placeholder) {
                        element.placeholder = translation;
                    }
                } else {
                    element.textContent = translation;
                }
            });

            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            
            const fetchedCategories = categories.filter(cat => cat.id !== 'all');
            categories = [ { id: 'all', name: t('all_categories_label'), icon: 'fas fa-th' }, ...fetchedCategories ];

            renderProducts();
            renderMainCategories();
            renderCategoriesSheet();
            if (document.getElementById('cartSheet').classList.contains('show')) renderCart();
            if (document.getElementById('favoritesSheet').classList.contains('show')) renderFavoritesPage();
        }

        function updateContactLinksUI() {
            if (!contactInfo) return;
        }
        
        function updateActiveNav(activeBtnId) {
            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(activeBtnId);
            if(activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        
        function formatDescription(text) {
            if (!text) return '';
            let escapedText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+)/g;
            let textWithLinks = escapedText.replace(urlRegex, (url) => {
                const hyperLink = url.startsWith('http') ? url : `https://${url}`;
                return `<a href="${hyperLink}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            });
            return textWithLinks.replace(/\n/g, '<br>');
        }

        async function requestNotificationPermission() {
            console.log('Requesting notification permission...');
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    showNotification('مۆڵەتی ناردنی ئاگەداری درا', 'success');
                    const currentToken = await getToken(messaging, {
                        vapidKey: 'BIepTNN6INcxIW9Of96udIKoMXZNTmP3q3aflB6kNLY3FnYe_3U6bfm3gJirbU9RgM3Ex0o1oOScF_sRBTsPyfQ'
                    });

                    if (currentToken) {
                        console.log('FCM Token:', currentToken);
                        await saveTokenToFirestore(currentToken);
                    } else {
                        console.log('No registration token available.');
                    }
                } else {
                    console.log('Unable to get permission to notify.');
                    showNotification('مۆڵەت نەدرا', 'error');
                }
            } catch (error) {
                console.error('An error occurred while requesting permission: ', error);
            }
        }

        async function saveTokenToFirestore(token) {
            try {
                const tokensCollection = collection(db, 'device_tokens');
                await setDoc(doc(tokensCollection, token), {
                    createdAt: Date.now()
                });
                console.log('Token saved to Firestore.');
            } catch (error) {
                console.error('Error saving token to Firestore: ', error);
            }
        }

        function saveFavorites() {
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
        }
        
        function isFavorite(productId) {
            return favorites.includes(productId);
        }

        function toggleFavorite(productId) {
            const productIndex = favorites.indexOf(productId);
            if (productIndex > -1) {
                favorites.splice(productIndex, 1);
                showNotification(t('product_removed_from_favorites'), 'error');
            } else {
                favorites.push(productId);
                showNotification(t('product_added_to_favorites'), 'success');
            }
            saveFavorites();
            renderProducts(); 
            if (document.getElementById('favoritesSheet').classList.contains('show')) {
                renderFavoritesPage();
            }
        }

        function renderFavoritesPage() {
            favoritesContainer.innerHTML = '';
            const favoritedProducts = products.filter(p => favorites.includes(p.id));

            if (favoritedProducts.length === 0) {
                emptyFavoritesMessage.style.display = 'block';
                favoritesContainer.style.display = 'none';
            } else {
                emptyFavoritesMessage.style.display = 'none';
                favoritesContainer.style.display = 'grid';
                favoritedProducts.forEach(product => {
                    const productCard = createProductCardElement(product);
                    favoritesContainer.appendChild(productCard);
                });
            }
        }

        function saveCart() {
            localStorage.setItem(CART_KEY, JSON.stringify(cart));
            updateCartCount();
        }

        function updateCartCount() {
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            document.querySelectorAll('.cart-count').forEach(el => { el.textContent = totalItems; });
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
        
        function populateCategoryDropdown() {
            productCategorySelect.innerHTML = '<option value="" disabled selected>-- جۆرێک هەڵبژێرە --</option>';
            const categoriesWithoutAll = categories.filter(cat => cat.id !== 'all');
            categoriesWithoutAll.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat['name_' + currentLanguage] || cat.name;
                productCategorySelect.appendChild(option);
            });
        }

        function renderCategoriesSheet() {
            sheetCategoriesContainer.innerHTML = '';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'sheet-category-btn';
                btn.dataset.category = cat.id;
                if (currentCategory === cat.id) { btn.classList.add('active'); }
                const categoryName = cat['name_' + currentLanguage] || cat.name;
                btn.innerHTML = `<i class="${cat.icon}"></i> ${categoryName}`;
                
                btn.onclick = () => {
                    currentCategory = cat.id;
                    currentSubcategory = 'all'; 
                    renderSubcategories(currentCategory);
                    renderProducts();
                    history.back();
                    renderMainCategories();
                    showPage('mainPage');
                };

                sheetCategoriesContainer.appendChild(btn);
            });
        }

        async function renderSubcategories(categoryId) {
            const subcategoriesContainer = document.getElementById('subcategoriesContainer');
            subcategoriesContainer.innerHTML = '';

            if (categoryId === 'all') {
                return;
            }

            try {
                const subcategoriesQuery = collection(db, "categories", categoryId, "subcategories");
                const querySnapshot = await getDocs(subcategoriesQuery);
                
                subcategories = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (subcategories.length === 0) return;

                const allBtn = document.createElement('button');
                allBtn.className = 'subcategory-btn active';
                allBtn.textContent = t('all_categories_label');
                allBtn.onclick = () => {
                    currentSubcategory = 'all';
                    document.querySelectorAll('.subcategory-btn').forEach(b => b.classList.remove('active'));
                    allBtn.classList.add('active');
                    renderProducts();
                };
                subcategoriesContainer.appendChild(allBtn);

                subcategories.forEach(subcat => {
                    const subcatBtn = document.createElement('button');
                    subcatBtn.className = 'subcategory-btn';
                    subcatBtn.textContent = subcat['name_' + currentLanguage] || subcat.name_ku_sorani;
                    subcatBtn.onclick = () => {
                        currentSubcategory = subcat.id;
                        document.querySelectorAll('.subcategory-btn').forEach(b => b.classList.remove('active'));
                        subcatBtn.classList.add('active');
                        renderProducts();
                    };
                    subcategoriesContainer.appendChild(subcatBtn);
                });
            } catch (error) {
                console.error("Error fetching subcategories: ", error);
            }
        }

        function renderMainCategories() {
            const container = document.getElementById('mainCategoriesContainer');
            if (!container) return; 
            container.innerHTML = '';

            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'main-category-btn';
                btn.dataset.category = cat.id;

                if (currentCategory === cat.id) {
                    btn.classList.add('active');
                }

                const categoryName = cat['name_' + currentLanguage] || cat.name;
                btn.innerHTML = `<i class="${cat.icon}"></i> <span>${categoryName}</span>`;

                btn.onclick = () => {
                    currentCategory = cat.id;
                    currentSubcategory = 'all';
                    
                    renderMainCategories();
                    renderSubcategories(currentCategory);
                    renderProducts();
                };

                container.appendChild(btn);
            });
        }

        function showProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const descriptionText = (product.description && product.description[currentLanguage]) || (product.description && product.description['ku_sorani']) || '';
            const imageUrls = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls : (product.image ? [product.image] : []);
            
            const imageContainer = document.getElementById('sheetImageContainer');
            const thumbnailContainer = document.getElementById('sheetThumbnailContainer');
            imageContainer.innerHTML = '';
            thumbnailContainer.innerHTML = '';

            if (imageUrls.length > 0) {
                imageUrls.forEach((url, index) => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = product.name;
                    if (index === 0) img.classList.add('active');
                    imageContainer.appendChild(img);
                    
                    const thumb = document.createElement('img');
                    thumb.src = url;
                    thumb.alt = `Thumbnail of ${product.name}`;
                    thumb.className = 'thumbnail';
                    if (index === 0) thumb.classList.add('active');
                    thumb.dataset.index = index;
                    thumbnailContainer.appendChild(thumb);
                });
            }

            let currentIndex = 0;
            const images = imageContainer.querySelectorAll('img');
            const thumbnails = thumbnailContainer.querySelectorAll('.thumbnail');
            const prevBtn = document.getElementById('sheetPrevBtn');
            const nextBtn = document.getElementById('sheetNextBtn');
            
            function updateSlider(index) {
                if (!images[index] || !thumbnails[index]) return;
                images.forEach(img => img.classList.remove('active'));
                thumbnails.forEach(thumb => thumb.classList.remove('active'));
                images[index].classList.add('active');
                thumbnails[index].classList.add('active');
                currentIndex = index;
            }

            if (imageUrls.length > 1) {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            }
            
            prevBtn.onclick = () => updateSlider((currentIndex - 1 + images.length) % images.length);
            nextBtn.onclick = () => updateSlider((currentIndex + 1) % images.length);
            thumbnails.forEach(thumb => thumb.onclick = () => updateSlider(parseInt(thumb.dataset.index)));

            document.getElementById('sheetProductName').textContent = product.name;
            document.getElementById('sheetProductDescription').innerHTML = formatDescription(descriptionText);
            
            const priceContainer = document.getElementById('sheetProductPrice');
            if (product.originalPrice && product.originalPrice > product.price) {
                priceContainer.innerHTML = `<span style="color: var(--accent-color);">${product.price.toLocaleString()} د.ع</span> <del style="color: var(--dark-gray); font-size: 16px; margin-right: 10px;">${product.originalPrice.toLocaleString()} د.ع</del>`;
            } else {
                priceContainer.innerHTML = `<span>${product.price.toLocaleString()} د.ع</span>`;
            }
            
            const addToCartButton = document.getElementById('sheetAddToCartBtn');
            addToCartButton.innerHTML = `<i class="fas fa-cart-plus"></i> ${t('add_to_cart')}`;
            addToCartButton.onclick = () => {
                addToCart(product.id);
                closeCurrentPopup();
            };

            openPopup('productDetailSheet');
        }

        function createProductCardElement(product) {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';

            const mainImage = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : (product.image || 'https://placehold.co/300x300/e2e8f0/2d3748?text=No+Image');
            
            let priceHTML = `<div class="product-price-container"><div class="product-price">${product.price.toLocaleString()} د.ع.</div></div>`;
            let discountBadgeHTML = '';
            const hasDiscount = product.originalPrice && product.originalPrice > product.price;

            if (hasDiscount) {
                priceHTML = `<div class="product-price-container"><span class="product-price">${product.price.toLocaleString()} د.ع.</span><del class="original-price">${product.originalPrice.toLocaleString()} د.ع.</del></div>`;
                const discountPercentage = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                discountBadgeHTML = `<div class="discount-badge">-%${discountPercentage}</div>`;
            }

            const isProdFavorite = isFavorite(product.id);
            const heartIconClass = isProdFavorite ? 'fas' : 'far';
            const favoriteBtnClass = isProdFavorite ? 'favorite-btn favorited' : 'favorite-btn';

            productCard.innerHTML = `
                <div class="product-image-container">
                    <img src="${mainImage}" alt="${product.name}" class="product-image" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/300x300/e2e8f0/2d3748?text=وێنە+نییە';">
                    ${discountBadgeHTML}
                    <button class="${favoriteBtnClass}" aria-label="Add to favorites">
                        <i class="${heartIconClass} fa-heart"></i>
                    </button>
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    ${priceHTML}
                    <button class="add-to-cart-btn-card">
                        <i class="fas fa-cart-plus"></i>
                        <span>${t('add_to_cart')}</span>
                    </button>
                </div>
                <div class="product-actions" style="display: ${isAdmin ? 'flex' : 'none'};">
                    <button class="edit-btn" aria-label="Edit product"><i class="fas fa-edit"></i></button>
                    <button class="delete-btn" aria-label="Delete product"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            productCard.addEventListener('click', (event) => {
                const target = event.target;
                const addToCartButton = target.closest('.add-to-cart-btn-card');
                
                if (addToCartButton) {
                    addToCart(product.id);
                    if (!addToCartButton.disabled) {
                        const originalContent = addToCartButton.innerHTML;
                        addToCartButton.disabled = true;
                        addToCartButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                        setTimeout(() => {
                            addToCartButton.innerHTML = `<i class="fas fa-check"></i> <span>${t('added_to_cart')}</span>`;
                            setTimeout(() => {
                                addToCartButton.innerHTML = originalContent;
                                addToCartButton.disabled = false;
                            }, 1500);
                        }, 500);
                    }
                } else if (target.closest('.edit-btn')) {
                    editProduct(product.id);
                } else if (target.closest('.delete-btn')) {
                    deleteProduct(product.id);
                } else if (target.closest('.favorite-btn')) {
                    toggleFavorite(product.id);
                } else if (!target.closest('a')) {
                    showProductDetails(product.id);
                }
            });
            return productCard;
        }
        
        function setupScrollAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.1
            });

            document.querySelectorAll('.product-card-reveal').forEach(card => {
                observer.observe(card);
            });
        }

        function renderSkeletonLoader() {
            skeletonLoader.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const skeletonCard = document.createElement('div');
                skeletonCard.className = 'skeleton-card';
                skeletonCard.innerHTML = `
                    <div class="skeleton-image shimmer"></div>
                    <div class="skeleton-text shimmer"></div>
                    <div class="skeleton-price shimmer"></div>
                    <div class="skeleton-button shimmer"></div>
                `;
                skeletonLoader.appendChild(skeletonCard);
            }
            skeletonLoader.style.display = 'grid';
            loader.style.display = 'none';
        }

        function renderProducts() {
            productsContainer.innerHTML = '';
            
            const filteredProducts = products.filter(product => {
                const categoryMatch = (currentCategory === 'all' || product.categoryId === currentCategory);
                const subcategoryMatch = (currentSubcategory === 'all' || !product.subcategoryId || product.subcategoryId === currentSubcategory);
                
                const productNameInCurrentLang = product['name_' + currentLanguage] || product.name_ku_sorani || product.name || '';
                const searchMatch = productNameInCurrentLang.toLowerCase().includes(currentSearch.toLowerCase());

                if (currentCategory !== 'all') {
                    return categoryMatch && subcategoryMatch && searchMatch;
                }
                return searchMatch;
            });


            if (filteredProducts.length === 0) {
                productsContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--dark-gray);">هیچ کاڵایەک نەدۆزرایەوە</div>';
                return;
            }

            filteredProducts.forEach(product => {
                const productCardElement = createProductCardElement(product);
                productCardElement.classList.add('product-card-reveal');
                productsContainer.appendChild(productCardElement);
            });

            setupScrollAnimations();
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            const mainImage = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : (product.image || '');
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) { existingItem.quantity++; } 
            else { cart.push({ id: product.id, name: product.name, price: product.price, image: mainImage, quantity: 1 }); }
            saveCart();
            showNotification(t('product_added_to_cart'));
        }

        function createProductImageInputs(imageUrls = []) {
            imageInputsContainer.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const url = imageUrls[i] || '';
                const isRequired = i === 0 ? 'required' : '';
                const placeholder = i === 0 ? 'لینکی وێنەی یەکەم (سەرەکی)' : `لینکی وێنەی ${['دووەم', 'سێیەم', 'چوارەم'][i-1]}`;
                const previewSrc = url || `https://placehold.co/40x40/e2e8f0/2d3748?text=${i + 1}`;
                const inputGroup = document.createElement('div');
                inputGroup.className = 'image-input-group';
                inputGroup.innerHTML = `<input type="text" class="productImageUrl" placeholder="${placeholder}" value="${url}" ${isRequired}><img src="${previewSrc}" class="image-preview-small" onerror="this.src='https://placehold.co/40x40/e2e8f0/2d3748?text=Err'">`;
                imageInputsContainer.appendChild(inputGroup);
            }
        }
        
        async function populateSubcategoriesDropdown(categoryId, selectedSubcategoryId = null) {
            if (!categoryId) {
                subcategorySelectContainer.style.display = 'none';
                return;
            }

            productSubcategorySelect.innerHTML = '<option value="" disabled selected>...چاوەڕێ بە</option>';
            productSubcategorySelect.disabled = true;
            subcategorySelectContainer.style.display = 'block';

            try {
                const subcategoriesQuery = collection(db, "categories", categoryId, "subcategories");
                const querySnapshot = await getDocs(subcategoriesQuery);
                
                productSubcategorySelect.innerHTML = '<option value="" disabled selected>-- جۆری لاوەکی هەڵبژێرە --</option>';
                
                if (querySnapshot.empty) {
                     productSubcategorySelect.innerHTML = '<option value="" disabled selected>هیچ جۆرێکی لاوەکی نییە</option>';
                } else {
                    querySnapshot.docs.forEach(doc => {
                        const subcat = { id: doc.id, ...doc.data() };
                        const option = document.createElement('option');
                        option.value = subcat.id;
                        option.textContent = subcat.name_ku_sorani || subcat.id;
                        if(subcat.id === selectedSubcategoryId) {
                            option.selected = true;
                        }
                        productSubcategorySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error fetching subcategories for form:", error);
                productSubcategorySelect.innerHTML = '<option value="" disabled selected>هەڵەیەک ڕوویدا</option>';
            } finally {
                productSubcategorySelect.disabled = false;
            }
        }

        async function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) { showNotification(t('product_not_found_error'), 'error'); return; }
            
            editingProductId = productId;
            formTitle.textContent = 'دەستکاری کردنی کاڵا';
            productForm.reset();
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productOriginalPrice').value = product.originalPrice || '';
            
            const categoryId = product.categoryId || product.category;
            document.getElementById('productCategoryId').value = categoryId;
            
            await populateSubcategoriesDropdown(categoryId, product.subcategoryId);

            if (product.description) {
                document.getElementById('productDescriptionKuSorani').value = product.description.ku_sorani || '';
                document.getElementById('productDescriptionKuBadini').value = product.description.ku_badini || '';
                document.getElementById('productDescriptionAr').value = product.description.ar || '';
            }

            const imageUrls = product.imageUrls || (product.image ? [product.image] : []);
            createProductImageInputs(imageUrls);
            document.getElementById('productExternalLink').value = product.externalLink || '';
            productForm.querySelector('button[type="submit"]').textContent = 'نوێکردنەوە';
            openPopup('productFormModal', 'modal');
        }

        async function deleteProduct(productId) { 
            if (!confirm(t('delete_confirm'))) return;
            try {
                await deleteDoc(doc(db, "products", productId));
                showNotification(t('product_deleted'), 'success');
            } catch (error) {
                showNotification(t('product_delete_error'), 'error');
            }
        }

        function renderCart() {
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                emptyCartMessage.style.display = 'block';
                cartTotal.style.display = 'none';
                cartActions.style.display = 'none';
                return;
            }
            emptyCartMessage.style.display = 'none';
            cartTotal.style.display = 'block';
            cartActions.style.display = 'block';
            renderCartActionButtons();
			
            let total = 0;
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                
                const itemNameInCurrentLang = (item.name && item.name[currentLanguage]) || (item.name && item.name.ku_sorani) || (typeof item.name === 'string' ? item.name : 'کاڵای بێ ناو');

                cartItem.innerHTML = `
                    <img src="${item.image}" alt="${itemNameInCurrentLang}" class="cart-item-image">
                    <div class="cart-item-details">
                        <div class="cart-item-title">${itemNameInCurrentLang}</div>
                        <div class="cart-item-price">${item.price.toLocaleString()} د.ع.</div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn increase-btn" data-id="${item.id}">+</button>
                            <span class="quantity-text">${item.quantity}</span>
                            <button class="quantity-btn decrease-btn" data-id="${item.id}">-</button>
                        </div>
                    </div>
                    <div class="cart-item-subtotal">
                        <div>${t('total_price')}</div>
                        <span>${itemTotal.toLocaleString()} د.ع.</span>
                        <button class="cart-item-remove" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                cartItemsContainer.appendChild(cartItem);
            });
            totalAmount.textContent = total.toLocaleString();
            document.querySelectorAll('.increase-btn').forEach(btn => btn.onclick = (e) => updateQuantity(e.currentTarget.dataset.id, 1));
            document.querySelectorAll('.decrease-btn').forEach(btn => btn.onclick = (e) => updateQuantity(e.currentTarget.dataset.id, -1));
            document.querySelectorAll('.cart-item-remove').forEach(btn => btn.onclick = (e) => removeFromCart(e.currentTarget.dataset.id));
        }

        function updateQuantity(productId, change) {
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.quantity += change;
                if (cartItem.quantity <= 0) { removeFromCart(productId); } 
                else { saveCart(); renderCart(); }
            }
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            saveCart();
            renderCart();
        }

        function generateOrderMessage() {
            if (cart.length === 0) return "";
            let message = t('order_greeting') + "\n\n";
            cart.forEach(item => {
                const itemNameInCurrentLang = (item.name && item.name[currentLanguage]) || (item.name && item.name.ku_sorani) || (typeof item.name === 'string' ? item.name : 'کاڵای بێ ناو');
                const itemDetails = t('order_item_details', { price: item.price.toLocaleString(), quantity: item.quantity });
                message += `- ${itemNameInCurrentLang} | ${itemDetails}\n`;
            });
            message += `\n${t('order_total')}: ${totalAmount.textContent} د.ع.\n`;

            if (userProfile.name && userProfile.address && userProfile.phone) {
                message += `\n${t('order_user_info')}\n`;
                message += `${t('order_user_name')}: ${userProfile.name}\n`;
                message += `${t('order_user_address')}: ${userProfile.address}\n`;
                message += `${t('order_user_phone')}: ${userProfile.phone}\n`;
            } else {
                 message += `\n${t('order_prompt_info')}\n`;
            }
            return message;
        }

        function populateParentCategorySelect() {
            const select = document.getElementById('parentCategorySelect');
            select.innerHTML = '<option value="">-- جۆرێک هەڵبژێرە --</option>';
            try {
                const categoriesWithoutAll = categories.filter(cat => cat.id !== 'all');
                categoriesWithoutAll.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat['name_' + currentLanguage] || cat.name; 
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error populating parent category select:", error);
                select.innerHTML = '<option value="">-- هەڵەیەک ڕوویدا --</option>';
            }
        }
		
		async function renderCartActionButtons() {
			const container = document.getElementById('cartActions');
			container.innerHTML = ''; 

			const methodsCollection = collection(db, 'settings', 'contactInfo', 'contactMethods');
			const q = query(methodsCollection, orderBy("createdAt"));

			const snapshot = await getDocs(q);
			if (snapshot.empty) {
				container.innerHTML = '<p>هیچ ڕێگایەکی ناردن دیاری نەکراوە.</p>';
				return;
			}

			snapshot.forEach(doc => {
				const method = { id: doc.id, ...doc.data() };
				const btn = document.createElement('button');
				btn.className = 'whatsapp-btn'; 
				btn.style.backgroundColor = method.color;
				
				const name = method['name_' + currentLanguage] || method.name_ku_sorani;
				btn.innerHTML = `<i class="${method.icon}"></i> <span>${name}</span>`;

				btn.onclick = () => {
					const message = generateOrderMessage();
					if (!message) return;

					let link = '';
					const encodedMessage = encodeURIComponent(message);
					const value = method.value;

					switch (method.type) {
						case 'whatsapp':
							link = `https://wa.me/${value}?text=${encodedMessage}`;
							break;
						case 'viber':
							link = `viber://chat?number=%2B${value}&text=${encodedMessage}`;
							break;
						case 'telegram':
							link = `https://t.me/${value}?text=${encodedMessage}`;
							break;
						case 'phone':
							link = `tel:${value}`;
							break;
						case 'url':
							link = value; 
							break;
					}

					if (link) {
						window.open(link, '_blank');
					}
				};

				container.appendChild(btn);
			});
		}

		async function deleteContactMethod(methodId) {
			if (confirm('دڵنیایت دەتەوێت ئەم شێوازە بسڕیتەوە؟')) {
				try {
					const methodRef = doc(db, 'settings', 'contactInfo', 'contactMethods', methodId);
					await deleteDoc(methodRef);
					showNotification('شێوازەکە سڕدرایەوە', 'success');
				} catch (error) {
					console.error("Error deleting contact method: ", error);
					showNotification('هەڵەیەک لە سڕینەوە ڕوویدا', 'error');
				}
			}
		}

		function renderContactMethodsAdmin() {
            const container = document.getElementById('contactMethodsListContainer');
            const methodsCollection = collection(db, 'settings', 'contactInfo', 'contactMethods');
            const q = query(methodsCollection, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p style="padding: 10px; text-align: center;">هیچ شێوازێک زیاد نەکراوە.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const method = { id: doc.id, ...doc.data() };
                    const name = method['name_' + currentLanguage] || method.name_ku_sorani;
                    
                    const item = document.createElement('div');
                    item.className = 'social-link-item';
                    item.innerHTML = `
                        <div class="item-info">
                            <i class="${method.icon}" style="color: ${method.color};"></i>
                            <div class="item-details">
                                <span class="item-name">${name}</span>
                                <span class="item-value">${method.value}</span>
                            </div>
                        </div>
                        <button class="delete-btn"><i class="fas fa-trash"></i></button>
                    `;
                    
                    item.querySelector('.delete-btn').onclick = () => deleteContactMethod(method.id);
                    container.appendChild(item);
                });
            });
        }

        function checkNewAnnouncements() {
            const q = query(announcementsCollection, orderBy("createdAt", "desc"), limit(1));
            onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    const latestAnnouncement = snapshot.docs[0].data();
                    const lastSeenTimestamp = localStorage.getItem('lastSeenAnnouncementTimestamp') || 0;

                    if (latestAnnouncement.createdAt > lastSeenTimestamp) {
                        notificationBadge.style.display = 'block';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                }
            });
        }

        async function renderUserNotifications() {
            const q = query(announcementsCollection, orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);

            notificationsListContainer.innerHTML = '';
            if (snapshot.empty) {
                notificationsListContainer.innerHTML = `<div class="cart-empty"><i class="fas fa-bell-slash"></i><p>${t('no_notifications_found')}</p></div>`;
                return;
            }

            let latestTimestamp = 0;
            snapshot.forEach(doc => {
                const announcement = doc.data();
                if (announcement.createdAt > latestTimestamp) {
                    latestTimestamp = announcement.createdAt;
                }

                const date = new Date(announcement.createdAt);
                const formattedDate = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;

                const title = (announcement.title && announcement.title[currentLanguage]) || (announcement.title && announcement.title.ku_sorani) || '';
                const content = (announcement.content && announcement.content[currentLanguage]) || (announcement.content && announcement.content.ku_sorani) || '';

                const item = document.createElement('div');
                item.className = 'notification-item';
                item.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-title">${title}</span>
                        <span class="notification-date">${formattedDate}</span>
                    </div>
                    <p class="notification-content">${content}</p>
                `;
                notificationsListContainer.appendChild(item);
            });

            localStorage.setItem('lastSeenAnnouncementTimestamp', latestTimestamp);
            notificationBadge.style.display = 'none';
        }

        async function deleteAnnouncement(id) {
            if (confirm(t('announcement_delete_confirm'))) {
                try {
                    await deleteDoc(doc(db, "announcements", id));
                    showNotification(t('announcement_deleted_success'), 'success');
                } catch (e) {
                    showNotification(t('error_generic'), 'error');
                }
            }
        }

        function renderAdminAnnouncementsList() {
            const container = document.getElementById('announcementsListContainer');
            const q = query(announcementsCollection, orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = `<p style="text-align:center; color: var(--dark-gray);">${t('no_announcements_sent')}</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const announcement = { id: doc.id, ...doc.data() };
                    const title = (announcement.title && announcement.title.ku_sorani) || 'بێ ناونیشان';
                    const item = document.createElement('div');
                    item.className = 'admin-notification-item';
                    item.innerHTML = `
                        <div class="admin-notification-details">
                            <div class="notification-title">${title}</div>
                        </div>
                        <button class="delete-btn"><i class="fas fa-trash"></i></button>
                    `;
                    item.querySelector('.delete-btn').addEventListener('click', () => deleteAnnouncement(announcement.id));
                    container.appendChild(item);
                });
            });
        }

        function updateAdminUI(isAdmin) {
            document.querySelectorAll('.product-actions').forEach(el => el.style.display = isAdmin ? 'flex' : 'none');
            const adminCategoryManagement = document.getElementById('adminCategoryManagement'); 
            const adminContactMethodsManagement = document.getElementById('adminContactMethodsManagement');
            if (adminSocialMediaManagement) adminSocialMediaManagement.style.display = isAdmin ? 'block' : 'none';
            if (adminAnnouncementManagement) {
                adminAnnouncementManagement.style.display = isAdmin ? 'block' : 'none';
                if(isAdmin) renderAdminAnnouncementsList();
            }
            
            if (isAdmin) {
                settingsLogoutBtn.style.display = 'flex';
                settingsAdminLoginBtn.style.display = 'none';
                addProductBtn.style.display = 'flex';
                if (adminCategoryManagement) {
                    adminCategoryManagement.style.display = 'block';
                    populateParentCategorySelect();
                }
				if (adminContactMethodsManagement) {
					adminContactMethodsManagement.style.display = 'block';
					renderContactMethodsAdmin(); 
				}
            } else {
                settingsLogoutBtn.style.display = 'none';
                settingsAdminLoginBtn.style.display = 'flex';
                addProductBtn.style.display = 'none';
                if (adminCategoryManagement) {
                    adminCategoryManagement.style.display = 'none';
                }
                if (adminContactMethodsManagement) {
					adminContactMethodsManagement.style.display = 'none';
				}
            }
        }

        async function deleteSocialMediaLink(linkId) {
            if (confirm('دڵنیایت دەتەوێت ئەم لینکە بسڕیتەوە؟')) {
                try {
                    const linkRef = doc(db, 'settings', 'contactInfo', 'socialLinks', linkId);
                    await deleteDoc(linkRef);
                    showNotification('لینکەکە سڕدرایەوە', 'success');
                } catch (error) {
                    console.error("Error deleting social link: ", error);
                    showNotification(t('error_generic'), 'error');
                }
            }
        }

        function renderSocialMediaLinks() {
            const socialLinksCollection = collection(db, 'settings', 'contactInfo', 'socialLinks');
            const q = query(socialLinksCollection, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                socialLinksListContainer.innerHTML = ''; 
                if (snapshot.empty) {
                    socialLinksListContainer.innerHTML = '<p style="padding: 10px; text-align: center;">هیچ لینکێک زیاد نەکراوە.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const link = { id: doc.id, ...doc.data() };
                    const name = link['name_' + currentLanguage] || link.name_ku_sorani;
                    
                    const item = document.createElement('div');
                    item.className = 'social-link-item';
                    item.innerHTML = `
                        <div class="item-info">
                            <i class="${link.icon}"></i>
                            <div class="item-details">
                                <span class="item-name">${name}</span>
                                <span class="item-value">${link.url}</span>
                            </div>
                        </div>
                        <button class="delete-btn"><i class="fas fa-trash"></i></button>
                    `;
                    
                    item.querySelector('.delete-btn').onclick = () => deleteSocialMediaLink(link.id);
                    socialLinksListContainer.appendChild(item);
                });
            });
        }

        function renderContactLinks() {
            const contactLinksContainer = document.getElementById('dynamicContactLinksContainer');
            const socialLinksCollection = collection(db, 'settings', 'contactInfo', 'socialLinks');
            const q = query(socialLinksCollection, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                contactLinksContainer.innerHTML = ''; 

                if (snapshot.empty) {
                    contactLinksContainer.innerHTML = '<p style="padding: 15px; text-align: center;">هیچ لینکی پەیوەندی نییە.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const link = doc.data();
                    const name = link['name_' + currentLanguage] || link.name_ku_sorani;
                    
                    const linkElement = document.createElement('a');
                    linkElement.href = link.url;
                    linkElement.target = '_blank';
                    linkElement.className = 'settings-item';
                    
                    linkElement.innerHTML = `
                        <div>
                            <i class="${link.icon}" style="margin-left: 10px;"></i>
                            <span>${name}</span>
                        </div>
                        <i class="fas fa-external-link-alt"></i>
                    `;
                    
                    contactLinksContainer.appendChild(linkElement);
                });
            });
        }

        function showWelcomeMessage() {
            if (!localStorage.getItem('hasVisited')) {
                openPopup('welcomeModal', 'modal');
                localStorage.setItem('hasVisited', 'true');
            }
        }
        
        function setupGpsButton() {
            const getLocationBtn = document.getElementById('getLocationBtn');
            const profileAddressInput = document.getElementById('profileAddress');
            const btnSpan = getLocationBtn.querySelector('span');
            const originalBtnText = btnSpan.textContent;

            if (!getLocationBtn) return;

            getLocationBtn.addEventListener('click', () => {
                if (!('geolocation' in navigator)) {
                    showNotification('وەرگەرێ تە پشتیڤانیێ ل GPS ناکەت', 'error');
                    return;
                }

                btnSpan.textContent = '...دگەریانێ دایە';
                getLocationBtn.disabled = true;

                navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
            });

            async function successCallback(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=ku,en`);
                    const data = await response.json();

                    if (data && data.display_name) {
                        profileAddressInput.value = data.display_name;
                        showNotification('ناڤ و نیشان هاتە وەرگرتن', 'success');
                    } else {
                        showNotification('نەشهام ناڤ و نیشانی ببینم', 'error');
                    }
                } catch (error) {
                    console.error('Reverse Geocoding Error:', error);
                    showNotification('خەلەتیەک د وەرگرتنا ناڤ و نیشانی دا روودا', 'error');
                } finally {
                    btnSpan.textContent = originalBtnText;
                    getLocationBtn.disabled = false;
                }
            }

            function errorCallback(error) {
                let message = '';
                switch (error.code) {
                    case 1:
                        message = 'تە رێک نەدا GPS بهێتە بکارئینان';
                        break;
                    case 2:
                        message = 'جهێ تە نەهاتە دیتن';
                        break;
                    case 3:
                        message = 'وەختێ داخازیێ بدوماهی هات';
                        break;
                    default:
                        message = 'خەلەتیەکا نەدیار روودا';
                        break;
                }
                showNotification(message, 'error');
                btnSpan.textContent = originalBtnText;
                getLocationBtn.disabled = false;
            }
        }

        function setupEventListeners() {
            homeBtn.onclick = () => {
                history.pushState({ type: 'page', id: 'mainPage' }, '', window.location.pathname);
                showPage('mainPage');
            };

            settingsBtn.onclick = () => {
                history.pushState({ type: 'page', id: 'settingsPage' }, '', '#settingsPage');
                showPage('settingsPage');
            };

            profileBtn.onclick = () => {
                openPopup('profileSheet');
                updateActiveNav('profileBtn');
            };

            cartBtn.onclick = () => { 
                openPopup('cartSheet');
                updateActiveNav('cartBtn');
            };
            
            categoriesBtn.onclick = () => {
                openPopup('categoriesSheet');
                updateActiveNav('categoriesBtn');
            };
            
            settingsFavoritesBtn.onclick = () => {
                openPopup('favoritesSheet');
            };
            
            settingsAdminLoginBtn.onclick = () => { 
                openPopup('loginModal', 'modal');
            };
            
            addProductBtn.onclick = () => {
                editingProductId = null;
                productForm.reset();
                createProductImageInputs();
                subcategorySelectContainer.style.display = 'none';
                formTitle.textContent = 'زیادکردنی کاڵای نوێ';
                productForm.querySelector('button[type="submit"]').textContent = 'پاشەکەوتکردن';
                openPopup('productFormModal', 'modal');
            };
            settingsLogoutBtn.onclick = async () => {
                await signOut(auth);
                // The onAuthStateChanged listener will handle the rest
            };

            sheetOverlay.onclick = () => closeCurrentPopup();
            document.querySelectorAll('.close').forEach(btn => btn.onclick = closeCurrentPopup);
            window.onclick = (e) => { if (e.target.classList.contains('modal')) closeCurrentPopup(); };
            loginForm.onsubmit = async (e) => {
                e.preventDefault();
                try {
                    await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
                } catch (error) {
                    showNotification(t('login_error'), 'error');
                }
            };
            
            productCategorySelect.addEventListener('change', (e) => {
                populateSubcategoriesDropdown(e.target.value);
            });
            
            productForm.onsubmit = async (e) => { 
                e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = '...چاوەڕێ بە';
                const imageUrls = Array.from(document.querySelectorAll('.productImageUrl')).map(input => input.value.trim()).filter(url => url !== '');
                if (imageUrls.length === 0) {
                    showNotification('پێویستە بەلایەنی کەمەوە لینکی یەک وێنە دابنێیت', 'error');
                    submitButton.disabled = false;
                    submitButton.textContent = editingProductId ? 'نوێکردنەوە' : 'پاشەکەوتکردن';
                    return;
                }
                
                const productDescriptionObject = {
                    ku_sorani: document.getElementById('productDescriptionKuSorani').value,
                    ku_badini: document.getElementById('productDescriptionKuBadini').value,
                    ar: document.getElementById('productDescriptionAr').value
                };

                try {
                    const productData = { 
                        name: document.getElementById('productName').value, 
                        price: parseInt(document.getElementById('productPrice').value), 
                        originalPrice: parseInt(document.getElementById('productOriginalPrice').value) || null, 
                        categoryId: document.getElementById('productCategoryId').value,
                        subcategoryId: document.getElementById('productSubcategoryId').value,
                        description: productDescriptionObject, 
                        imageUrls: imageUrls, 
                        createdAt: Date.now(), 
                        externalLink: document.getElementById('productExternalLink').value || null 
                    };
                    if (editingProductId) {
                        const { createdAt, ...updateData } = productData;
                        await updateDoc(doc(db, "products", editingProductId), updateData);
                        showNotification('کاڵا نوێکرایەوە', 'success');
                    } else {
                        await addDoc(productsCollection, productData);
                        showNotification('کاڵا زیادکرا', 'success');
                    }
                    closeCurrentPopup();
                } catch (error) {
                    showNotification(t('error_generic'), 'error');
                    console.error("Error saving product:", error);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = editingProductId ? 'نوێکردنەوە' : 'پاشەکەوتکردن';
                    editingProductId = null;
                }
            };

            imageInputsContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('productImageUrl')) {
                    const previewImg = e.target.nextElementSibling;
                    const url = e.target.value;
                    if (url) { previewImg.src = url; } 
                    else {
                        const index = Array.from(e.target.parentElement.parentElement.children).indexOf(e.target.parentElement);
                        previewImg.src = `https://placehold.co/40x40/e2e8f0/2d3748?text=${index + 1}`;
                    }
                }
            });
            searchInput.oninput = () => { 
                currentSearch = searchInput.value; 
                clearSearchBtn.style.display = currentSearch ? 'block' : 'none';
                renderProducts(); 
            };
            clearSearchBtn.onclick = () => {
                searchInput.value = '';
                currentSearch = '';
                clearSearchBtn.style.display = 'none';
                renderProducts();
            };
            
            contactToggle.onclick = () => {
                const container = document.getElementById('dynamicContactLinksContainer');
                const chevron = contactToggle.querySelector('.contact-chevron');
                container.classList.toggle('open');
                chevron.classList.toggle('open');
            };

            socialMediaToggle.onclick = () => {
                const container = adminSocialMediaManagement.querySelector('.contact-links-container');
                const chevron = socialMediaToggle.querySelector('.contact-chevron');
                container.classList.toggle('open');
                chevron.classList.toggle('open');
            };

            profileForm.onsubmit = (e) => {
                e.preventDefault();
                userProfile = {
                    name: document.getElementById('profileName').value,
                    address: document.getElementById('profileAddress').value,
                    phone: document.getElementById('profilePhone').value,
                };
                localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile));
                showNotification(t('profile_saved'), 'success');
                closeCurrentPopup();
            };
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.onclick = () => {
                    setLanguage(btn.dataset.lang);
                };
            });
            
            const installBtn = document.getElementById('installAppBtn');
            if (installBtn) {
              installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                  installBtn.style.display = 'none';
                  deferredPrompt.prompt();
                  const { outcome } = await deferredPrompt.userChoice;
                  console.log(`User response to the install prompt: ${outcome}`);
                  deferredPrompt = null;
                }
              });
            }

            const addCategoryForm = document.getElementById('addCategoryForm');
            const addSubcategoryForm = document.getElementById('addSubcategoryForm');

            if (addCategoryForm) {
                addCategoryForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitButton = e.target.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.textContent = '...پاشەکەوت دەکرێت';

                    const categoryData = {
                        name: document.getElementById('mainCategoryNameKuBadini').value,
                        name_ku_sorani: document.getElementById('mainCategoryNameKuSorani').value,
                        name_ku_badini: document.getElementById('mainCategoryNameKuBadini').value,
                        name_ar: document.getElementById('mainCategoryNameAr').value,
                        icon: document.getElementById('mainCategoryIcon').value,
                        order: parseInt(document.getElementById('mainCategoryOrder').value)
                    };

                    try {
                        await addDoc(categoriesCollection, categoryData);
                        showNotification('جۆری سەرەکی بە سەرکەوتوویی زیادکرا', 'success');
                        addCategoryForm.reset();
                    } catch (error) {
                        console.error("Error adding main category: ", error);
                        showNotification(t('error_generic'), 'error');
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = 'پاشەکەوتکردنی جۆری سەرەکی';
                    }
                });
            }

            if (addSubcategoryForm) {
                addSubcategoryForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitButton = e.target.querySelector('button[type="submit"]');
                    const parentCategoryId = document.getElementById('parentCategorySelect').value;

                    if (!parentCategoryId) {
                        showNotification('تکایە جۆری سەرەکی هەڵبژێرە', 'error');
                        return;
                    }

                    submitButton.disabled = true;
                    submitButton.textContent = '...پاشەکەوت دەکرێت';

                    const subcategoryData = {
                        name_ku_sorani: document.getElementById('subcategoryNameKuSorani').value,
                        name_ku_badini: document.getElementById('subcategoryNameKuBadini').value,
                        name_ar: document.getElementById('subcategoryNameAr').value,
                    };

                    try {
                        const subcategoriesCollectionRef = collection(db, "categories", parentCategoryId, "subcategories");
                        await addDoc(subcategoriesCollectionRef, subcategoryData);
                        showNotification('جۆری لاوەکی بە سەرکەوتوویی زیادکرا', 'success');
                        addSubcategoryForm.reset();
                    } catch (error) {
                        console.error("Error adding subcategory: ", error);
                        showNotification(t('error_generic'), 'error');
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = 'پاشەکەوتکردنی جۆری لاوەکی';
                    }
                });
            }

            const addContactMethodForm = document.getElementById('addContactMethodForm');
			if (addContactMethodForm) {
				addContactMethodForm.addEventListener('submit', async (e) => {
					e.preventDefault();
					const submitButton = e.target.querySelector('button[type="submit"]');
					submitButton.disabled = true;

					const methodData = {
						type: document.getElementById('contactMethodType').value,
						value: document.getElementById('contactMethodValue').value,
						name_ku_sorani: document.getElementById('contactMethodNameKuSorani').value,
						name_ku_badini: document.getElementById('contactMethodNameKuBadini').value,
						name_ar: document.getElementById('contactMethodNameAr').value,
						icon: document.getElementById('contactMethodIcon').value,
						color: document.getElementById('contactMethodColor').value,
						createdAt: Date.now()
					};

					try {
						const methodsCollection = collection(db, 'settings', 'contactInfo', 'contactMethods');
						await addDoc(methodsCollection, methodData);
						showNotification('شێوازی نوێ بە سەرکەوتوویی زیادکرا', 'success');
						addContactMethodForm.reset();
					} catch (error) {
						console.error("Error adding contact method: ", error);
						showNotification(t('error_generic'), 'error');
					} finally {
						submitButton.disabled = false;
					}
				});
			}

            notificationBtn.addEventListener('click', () => {
                openPopup('notificationsSheet');
            });

            if (announcementForm) {
                announcementForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitButton = e.target.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.textContent = '...د ناردنێ دایە';

                    const announcementData = {
                        title: {
                            ku_sorani: document.getElementById('announcementTitleKuSorani').value,
                            ku_badini: document.getElementById('announcementTitleKuBadini').value,
                            ar: document.getElementById('announcementTitleAr').value,
                        },
                        content: {
                            ku_sorani: document.getElementById('announcementContentKuSorani').value,
                            ku_badini: document.getElementById('announcementContentKuBadini').value,
                            ar: document.getElementById('announcementContentAr').value,
                        },
                        createdAt: Date.now()
                    };

                    try {
                        await addDoc(announcementsCollection, announcementData);
                        showNotification('ئاگەهداری ب سەرکەفتیانە هاتە ناردن', 'success');
                        announcementForm.reset();
                    } catch (error) {
                        console.error("Error sending announcement: ", error);
                        showNotification(t('error_generic'), 'error');
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = t('send_announcement_button');
                    }
                });
            }

            const enableNotificationsBtn = document.getElementById('enableNotificationsBtn');
            if (enableNotificationsBtn) {
                enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
            }

            onMessage(messaging, (payload) => {
                console.log('Foreground message received: ', payload);
                const title = payload.notification.title;
                const body = payload.notification.body;
                showNotification(`${title}: ${body}`, 'success');
            });
        }
        
        // ========== START: CORRECTED ADMIN/AUTH LOGIC ==========
        onAuthStateChanged(auth, async (user) => {
            // !!! گرنگ: ڤی UID بگوهورە بۆ UID یا ئەکاونتێ خۆ یێ ئەدمینی !!!
            // 1. بچە Firebase Console
            // 2. بچە Authentication > Users
            // 3. UID یا ئەکاونتێ خۆ کۆپی بکە و ل ڤێرێ بدانە
            const adminUID = "YOUR_ADMIN_UID_HERE"; 
        
            if (user && user.uid === adminUID) {
                isAdmin = true;
                sessionStorage.setItem('isAdmin', 'true'); 
                
                // Close the login modal if it's open upon successful login
                if (document.getElementById('loginModal').style.display === 'block') {
                    closeCurrentPopup();
                }
            } else {
                isAdmin = false;
                sessionStorage.removeItem('isAdmin');
                if(user) { // If a non-admin user is logged in, log them out.
                    await signOut(auth);
                }
            }
        
            updateAdminUI(isAdmin);
            renderProducts(); 
        });
        // ========== END: CORRECTED ADMIN/AUTH LOGIC ==========


        function init() {
            renderSkeletonLoader();
            const categoriesQuery = query(categoriesCollection, orderBy("order", "asc"));
            onSnapshot(categoriesQuery, (snapshot) => {
                const fetchedCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                categories = [ { id: 'all', name: t('all_categories_label'), icon: 'fas fa-th' }, ...fetchedCategories ];
                populateCategoryDropdown();
                renderMainCategories();
                setLanguage(currentLanguage);
            });
            const productsQuery = query(productsCollection, orderBy("createdAt", "desc"));
            onSnapshot(productsQuery, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                skeletonLoader.style.display = 'none';
                productsContainer.style.display = 'grid';
                renderProducts();
            });

            const contactInfoRef = doc(db, "settings", "contactInfo");
            onSnapshot(contactInfoRef, (docSnap) => {
                if (docSnap.exists()) {
                    contactInfo = docSnap.data();
                    updateContactLinksUI();
                } else {
                    console.log("No contact info document found!");
                }
            });

            updateCartCount();
            setupEventListeners();
            setLanguage(currentLanguage);
            renderSocialMediaLinks();
            renderContactLinks();
            checkNewAnnouncements(); 
            showWelcomeMessage(); 
            setupGpsButton();
            handleInitialPageLoad(); // This handles initial page and popup state
        }

        document.addEventListener('DOMContentLoaded', init);

        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          const installBtn = document.getElementById('installAppBtn');
          if (installBtn) {
            installBtn.style.display = 'flex';
          }
        });

        if ('serviceWorker' in navigator) {
            const updateNotification = document.getElementById('update-notification');
            const updateNowBtn = document.getElementById('update-now-btn');

            navigator.serviceWorker.register('/sw.js').then(registration => {
                console.log('Service Worker registered successfully.');

                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    console.log('New service worker found!', newWorker);

                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            updateNotification.classList.add('show');
                        }
                    });
                });
                
                updateNowBtn.addEventListener('click', () => {
                    registration.waiting.postMessage({ action: 'skipWaiting' });
                });

            }).catch(err => {
                console.log('Service Worker registration failed: ', err);
            });

            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('New Service Worker activated. Reloading page...');
                window.location.reload();
            });
        }
    </script>
</body>
</html>